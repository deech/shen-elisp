<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shen Elisp</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Aditya Siram" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Shen Elisp</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc100d3b">1. Package Details</a></li>
<li><a href="#orgef5269d">2. KLambda Primitives</a>
<ul>
<li><a href="#org6372af0">2.1. License</a></li>
<li><a href="#org545e034">2.2. Implementation Constants</a></li>
<li><a href="#orgc880d93">2.3. Symbols</a>
<ul>
<li><a href="#orgd8bb037">2.3.1. Prefixing Utilities</a></li>
</ul>
</li>
<li><a href="#orgf703c38">2.4. Assignments</a></li>
<li><a href="#org4653727">2.5. KLambda Constants</a></li>
<li><a href="#orgc519f8d">2.6. Boolean Operations</a></li>
<li><a href="#orgae0d3ce">2.7. Lambdas</a></li>
<li><a href="#orgcc47851">2.8. Lets</a></li>
<li><a href="#org3ea342a">2.9. Defuns</a></li>
<li><a href="#org32d53b0">2.10. Equality</a></li>
<li><a href="#orga46275c">2.11. Other Generic Functions</a></li>
<li><a href="#orgc69bed8">2.12. Lists</a></li>
<li><a href="#orgbcfdd2a">2.13. Strings</a></li>
<li><a href="#org32d5bd2">2.14. Error Handling</a></li>
<li><a href="#org79fade9">2.15. Vectors</a></li>
<li><a href="#orgfb653f1">2.16. Arithmetic Operations</a></li>
<li><a href="#orgfea81be">2.17. Time</a></li>
<li><a href="#orgf023406">2.18. Streams and I/O</a></li>
</ul>
</li>
<li><a href="#orgf93b424">3. Utilities</a>
<ul>
<li><a href="#orgf9ca75c">3.1. Lookup</a></li>
<li><a href="#org2d7f67d">3.2. AST Utilities</a>
<ul>
<li><a href="#org1fede55">3.2.1. Paths</a></li>
<li><a href="#org08564fd">3.2.2. AST Getter/Setter</a></li>
<li><a href="#orgb29fa7a">3.2.3. AST Search</a></li>
<li><a href="#org01abc05">3.2.4. Path Utilities</a></li>
<li><a href="#org95a33fd">3.2.5. AST Modification</a></li>
</ul>
</li>
<li><a href="#orgc18f8b2">3.3. List</a>
<ul>
<li><a href="#org43887e7">3.3.1. Detect Dotted Pair</a></li>
<li><a href="#org88789e5">3.3.2. List Filtering</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb538ab3">4. Rewriting The AST</a>
<ul>
<li><a href="#org8ffa5f1">4.1. Walking The AST</a></li>
<li><a href="#org52f0e1d">4.2. Function Application</a></li>
<li><a href="#org7050be6">4.3. Finding Tail Calls</a></li>
<li><a href="#org202a339">4.4. Generating A TCO'ed Function</a></li>
<li><a href="#org521dfcf">4.5. Modifying The AST</a></li>
<li><a href="#org5bc6dbb">4.6. (Unused) Isolating and Filling</a></li>
</ul>
</li>
<li><a href="#org8991d7e">5. Optimizations</a>
<ul>
<li><a href="#org4db61ef">5.1. Consolidate Call Chains</a></li>
<li><a href="#org29f34f3">5.2. Consolidate Cons</a></li>
<li><a href="#org7ac6d10">5.3. Consolidate @s</a></li>
<li><a href="#org55b123b">5.4. Consolidate tl</a></li>
<li><a href="#org080ef92">5.5. Add 1+'s</a></li>
<li><a href="#org749c258">5.6. Nil Comparisons To Null</a></li>
</ul>
</li>
<li><a href="#orgeed8f15">6. Overrides</a>
<ul>
<li><a href="#orgb099cae">6.1. Performance</a></li>
<li><a href="#org3da0e33">6.2. Hash Table</a></li>
<li><a href="#org5400114">6.3. Namespacing</a></li>
<li><a href="#org84f1566">6.4. Bug Fixes</a></li>
</ul>
</li>
<li><a href="#org6d93d5a">7. Evaluate KLambda</a>
<ul>
<li><a href="#orgc281f1f">7.1. Generate From Seed KLambda Files</a>
<ul>
<li><a href="#org34c67da">7.1.1. Evaluating Bootstrapped KLambda</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5b7fbf5">8. Providing The Primitives</a></li>
<li><a href="#orgc420a27">9. Overlays</a>
<ul>
<li><a href="#orga4f7f1a">9.1. License</a></li>
<li><a href="#org2ffa05c">9.2. Symbol Table</a></li>
<li><a href="#orgc0d74ec">9.3. Repl</a>
<ul>
<li><a href="#orgf35e81e">9.3.1. Questions</a></li>
<li><a href="#org79ef188">9.3.2. Changing Directories</a></li>
</ul>
</li>
<li><a href="#org7605357">9.4. Provide it</a></li>
</ul>
</li>
<li><a href="#org7cf0e03">10. Shen REPL</a>
<ul>
<li><a href="#org2401594">10.1. Credits</a></li>
<li><a href="#orgc914fd4">10.2. Prompt</a></li>
<li><a href="#orgaacaf97">10.3. Input Events</a></li>
<li><a href="#org37268e6">10.4. Sending Input</a></li>
<li><a href="#org9e4d6b2">10.5. Evaluating User Input</a></li>
<li><a href="#orge6d04f7">10.6. The REPL Mode</a></li>
<li><a href="#org06658cf">10.7. Starting the REPL</a></li>
<li><a href="#org270053c">10.8. Provide it</a></li>
</ul>
</li>
<li><a href="#orgb70a2fe">11. Bootstrap</a>
<ul>
<li><a href="#org3d4557f">11.1. Collecting KLambda files</a></li>
<li><a href="#org31e1acb">11.2. Modifying The Elisp Reader For KLambda</a></li>
<li><a href="#org88f1618">11.3. Iterating over KLambda Files</a></li>
</ul>
</li>
<li><a href="#org12cfa52">12. The Runner</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgc100d3b" class="outline-2">
<h2 id="orgc100d3b"><span class="section-number-2">1</span> Package Details</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span>define-package
  <span style="color: #008000;">"shen-elisp"</span>
  <span style="color: #008000;">"19.2-0.0.1"</span>
  <span style="color: #008000;">"Shen implementation in Elisp"</span>
  '<span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>emacs <span style="color: #008000;">"24.4"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #006FE0;">:url</span> <span style="color: #008000;">"http://github.com/deech/shen-elisp"</span>
  <span style="color: #006FE0;">:keywords</span> '<span style="color: #7388D6;">(</span><span style="color: #008000;">"shen"</span> <span style="color: #008000;">"elisp"</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgef5269d" class="outline-2">
<h2 id="orgef5269d"><span class="section-number-2">2</span> KLambda Primitives</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-org6372af0" class="outline-3">
<h3 id="org6372af0"><span class="section-number-3">2.1</span> License</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">-*- lexical-binding: t -*-</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Copyright (c) 2015-2016 Aditya Siram. All Rights Reserved.</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">BSD 3-Clause License: http://opensource.org/licenses/BSD-3-Clause</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org545e034" class="outline-3">
<h3 id="org545e034"><span class="section-number-3">2.2</span> Implementation Constants</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defconst</span> <span style="color: #BA36A5;">shen/prefix</span> <span style="color: #008000;">"shen/"</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc880d93" class="outline-3">
<h3 id="orgc880d93"><span class="section-number-3">2.3</span> Symbols</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Symbols in KLambda (and Shen) are very much like symbols in Elisp :
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/symbol-p</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>not <span style="color: #909183;">(</span><span style="color: #0000FF;">or</span> <span style="color: #709870;">(</span>consp X<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>bufferp X<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>vectorp X<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>numberp X<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>stringp X<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
except for a few important differences:
</p>
<ol class="org-ol">
<li><p>
In KLambda (and Shen) symbols don't need to be quoted:
</p>
<pre class="example">
&gt; some-symbol
some-symbol
</pre>
<p>
whereras in Elisp they do:
</p>
<pre class="example">
&gt; some-symbol
*** Eval error ***  Symbol's value as variable is void: some-symbol
&gt; 'some-symbol
some-symbol
</pre></li>

<li><p>
When calling a symbol function in Shen you can
simply apply the arguments:
</p>
<pre class="example">
(defun call-f (f a b c) (f a b c))
</pre>
<p>
But in Elisp we need to use <code>funcall</code>:
</p>
<pre class="example">
(defun call-f (f a b c) (funcall f a b c))
</pre></li>
</ol>

<p>
To deal with these differences a <a href="#org8ffa5f1">pass</a> is taken over the KLambda ast (before
macroexpansion) that identifies symbols that requires quoting and function calls
that need to be applied correctly.
</p>

<p>
Interning a Shen symbol delegates to Elisp's <code>intern</code>:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/intern</span> <span style="color: #7388D6;">(</span>String<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>intern String<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
as does <code>shen/symbol-&gt;string</code>:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/symbol-&gt;string</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>symbol-name X<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
<div id="outline-container-orgd8bb037" class="outline-4">
<h4 id="orgd8bb037"><span class="section-number-4">2.3.1</span> Prefixing Utilities</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
Elisp does not have namespaces so to insulate the rest of the user's Emacs image
the primitive functions, user-defined functions and variables are prefixed with <code>shen/</code>.
Raw symbols are not touched since they can't harm existing Elisp code.
</p>

<p>
When decompiling Klambda to Elisp we need functions that prefix the appropriate
symbol with <code>shen/</code>:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/prefix-symbol</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>shen/symbol-p X<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span>intern <span style="color: #709870;">(</span>concat shen/prefix <span style="color: #907373;">(</span>symbol-name X<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    X<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
, detect if it has already has a prefixed:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/symbol-prefixed-p</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> <span style="color: #909183;">(</span>shen/symbol-p X<span style="color: #909183;">)</span> <span style="color: #909183;">(</span>string-prefix-p shen/prefix <span style="color: #709870;">(</span>symbol-name X<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
, and removes the prefix it for consumption by Shen:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/unprefix-symbol</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>shen/internal/symbol-prefixed-p X<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span>intern <span style="color: #709870;">(</span>substring <span style="color: #907373;">(</span>symbol-name X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>length shen/prefix<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    X<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf703c38" class="outline-3">
<h3 id="orgf703c38"><span class="section-number-3">2.4</span> Assignments</h3>
<div class="outline-text-3" id="text-2-4">
<p>
When setting and getting a variable, the name is prefixed to prevent the user from stomping over one that
already exists in the Emacs image. See <a href="#orgd8bb037">2.3.1</a> for more on how this works.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/set</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>set <span style="color: #909183;">(</span>intern <span style="color: #709870;">(</span>concat shen/prefix <span style="color: #907373;">(</span>symbol-name X<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>prefixed<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span><span style="color: #0000FF;">or</span>  <span style="color: #907373;">(</span><span style="color: #0000FF;">and</span> <span style="color: #6276BA;">(</span>symbolp Y<span style="color: #6276BA;">)</span>
                   <span style="color: #6276BA;">(</span>not <span style="color: #858580;">(</span>shen/internal/symbol-prefixed-p Y<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                   <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
                     <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> prefixed <span style="color: #80A880;">(</span>shen/internal/prefix-symbol Y<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                     <span style="color: #858580;">(</span><span style="color: #0000FF;">or</span> <span style="color: #80A880;">(</span>boundp prefixed<span style="color: #80A880;">)</span>
                         <span style="color: #80A880;">(</span>fboundp prefixed<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                   prefixed<span style="color: #907373;">)</span>
              Y<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/value</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">condition-case</span> ex
      <span style="color: #909183;">(</span>symbol-value <span style="color: #709870;">(</span>intern <span style="color: #907373;">(</span>concat shen/prefix <span style="color: #6276BA;">(</span>symbol-name X<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>'error <span style="color: #709870;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #907373;">(</span>format <span style="color: #008000;">"%s has not been assigned"</span> X<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4653727" class="outline-3">
<h3 id="org4653727"><span class="section-number-3">2.5</span> KLambda Constants</h3>
<div class="outline-text-3" id="text-2-5">
<p>
Once <a href="#orgf703c38">the assigning mechanism</a> is in place the spec requires some global variables:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span>shen/set '*home-directory* <span style="color: #008000;">""</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>shen/set '*stoutput* standard-output<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>shen/set '*stinput* <span style="color: #7388D6;">[</span><span style="color: #909183;">()</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>shen/set '*language* <span style="color: #008000;">"Elisp"</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>shen/set '*implementation* <span style="color: #008000;">"Elisp"</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>shen/set '*porters* <span style="color: #008000;">"Aditya Siram"</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>shen/set '*release* <span style="color: #008000;">"0.0.0.1"</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>shen/set '*port* <span style="color: #D0372D;">1.7</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>shen/set '*os* <span style="color: #008000;">"Linux"</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc519f8d" class="outline-3">
<h3 id="orgc519f8d"><span class="section-number-3">2.6</span> Boolean Operations</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Unlike Elisp in KLambda booleans are <code>false</code> and <code>true</code>, distinct symbols which
are not synonymous with <code>nil</code> and <code>(not nil)</code> so wrappers are required:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/internal/shen-&gt;predicate</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>eq X 'true<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/internal/predicate-&gt;shen</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> X <span style="color: #909183;">(</span><span style="color: #0000FF;">quote</span> true<span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #0000FF;">quote</span> false<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Since <code>if</code> , <code>and</code> and <code>or</code> are special forms they are defined as macros to
preserve evaluation order.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/if</span> <span style="color: #7388D6;">(</span>X Y Z<span style="color: #7388D6;">)</span>
  `<span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>eq ,X 'true<span style="color: #909183;">)</span> ,Y ,Z<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/and</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span> `<span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span><span style="color: #0000FF;">and</span> <span style="color: #709870;">(</span>eq ,X 'true<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>eq ,Y 'true<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/or</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span> `<span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span><span style="color: #0000FF;">or</span> <span style="color: #709870;">(</span>eq ,X 'true<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>eq ,Y 'true<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
KLambda's <code>cond</code>, unlike Elisp's forbids a fallthrough case - one of the
predicates must be true.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/cond</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">&amp;rest</span> CASES<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>predicates-quoted-cases
          <span style="color: #907373;">(</span>mapcar <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>predicate-result-pair<span style="color: #858580;">)</span>
                    <span style="color: #858580;">(</span>list <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> <span style="color: #887070;">(</span>shen/symbol-p <span style="color: #707183;">(</span>nth <span style="color: #D0372D;">0</span> predicate-result-pair<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                              <span style="color: #887070;">(</span>list 'quote <span style="color: #707183;">(</span>nth <span style="color: #D0372D;">0</span> predicate-result-pair<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                            <span style="color: #887070;">(</span>list 'shen/internal/shen-&gt;predicate <span style="color: #707183;">(</span>nth <span style="color: #D0372D;">0</span> predicate-result-pair<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                          <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">1</span> predicate-result-pair<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                  CASES<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>fallthrough-added <span style="color: #907373;">(</span>append predicates-quoted-cases <span style="color: #6276BA;">(</span>list '<span style="color: #858580;">(</span>t <span style="color: #80A880;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"One of the cond predicates must be true."</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    `<span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> ,@fallthrough-added<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgae0d3ce" class="outline-3">
<h3 id="orgae0d3ce"><span class="section-number-3">2.7</span> Lambdas</h3>
<div class="outline-text-3" id="text-2-7">
<p>
Since Shen supports currying by default KLambda's <code>lambda</code> form is stripped down to only accept one
argument.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">lambda</span> X <span style="color: #7388D6;">(</span>...<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Multiple arguments are supported via nesting:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">lambda</span> X <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> Y <span style="color: #909183;">(</span>...<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
The implementation delegates to Elisp's <code>lambda</code> form:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/lambda</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>eq X nil<span style="color: #909183;">)</span>
      `<span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">()</span> ,Y<span style="color: #909183;">)</span>
    `<span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>,X<span style="color: #709870;">)</span> ,Y<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcc47851" class="outline-3">
<h3 id="orgcc47851"><span class="section-number-3">2.8</span> Lets</h3>
<div class="outline-text-3" id="text-2-8">
<p>
KLambda's <code>let</code> in a similar way only takes one assignment:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">let</span> X Y ...<span style="color: #707183;">)</span>
</pre>
</div>

<p>
Similarly multiple assignments are supported via nested <code>lets</code>:
</p>
<pre class="example">
(let W X (let Y Z ...))
</pre>

<p>
The implementation delegates to Elisp's <code>let</code>:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/let</span> <span style="color: #7388D6;">(</span>X Y Z<span style="color: #7388D6;">)</span>
  `<span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>,X ,Y<span style="color: #709870;">)</span><span style="color: #909183;">)</span> ,Z<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ea342a" class="outline-3">
<h3 id="org3ea342a"><span class="section-number-3">2.9</span> Defuns</h3>
<div class="outline-text-3" id="text-2-9">
<p>
The structure of <code>defun</code> in KLambda is identical to Elisp's so a straight
translation works.
</p>

<p>
Functions are required to be tail-call optimized but that is done below
before the body is spliced in.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/defun</span> <span style="color: #7388D6;">(</span>F Args Body<span style="color: #7388D6;">)</span> `<span style="color: #7388D6;">(</span><span style="color: #0000FF;">defun</span> ,F ,Args ,Body<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org32d53b0" class="outline-3">
<h3 id="org32d53b0"><span class="section-number-3">2.10</span> Equality</h3>
<div class="outline-text-3" id="text-2-10">
<p>
Using <a href="#org79fade9">hash-tables for tuples and vectors</a> complicates equality. It also slows
down equality tests across the board but using hash-tables still results in
a substantial net-gain.
</p>

<p>
In the case of <a href="#coderef-strings-and-numbers"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-strings-and-numbers');" onmouseout="CodeHighlightOff(this, 'coderef-strings-and-numbers');">strings and numbers</a> using built-in functions suffices but for
compound structures which might contain hash-tables simply using <code>(equal ...)</code>
will not work because two hash-tables containing the same keys and values are not
<code>equal</code>.
</p>

<p>
While <code>(equal ...)</code> isn't sufficient, it does have the nice property of being
right when it returns true. Two structures which are <code>(equal ...)</code> are equal but
<code>(equal ...)</code> returning nil does not mean they are unequal. So we first try the
<a href="#coderef-obvious-equality-test"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-obvious-equality-test');" onmouseout="CodeHighlightOff(this, 'coderef-obvious-equality-test');">obvious equality test</a> and only perform the expensive tests when that fails.
</p>

<p>
If both arguments are cons lists and the equality check has failed it might be
that they contain hash tables so we need to check for that. First ensure they
are the same length. Note that we use <code>safe-length</code> and not <code>length</code>. Only the
former is robust to lists that end in dotted pairs, eg. <code>'(a b c . d)</code> which are
sometimes generated from KLambda code.
</p>

<p>
Then we loop through the elements of the list ensuring that the <a href="#coderef-elements are of the same type"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-elements are of the same type');" onmouseout="CodeHighlightOff(this, 'coderef-elements are of the same type');">elements are of the same type</a> , or <a href="#coderef-store the inner list"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-store the inner list');" onmouseout="CodeHighlightOff(this, 'coderef-store the inner list');">storing inner lists</a> as we encounter then or recursing to
<a href="#coderef-compare the elements"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-compare the elements');" onmouseout="CodeHighlightOff(this, 'coderef-compare the elements');">compare the elements</a>. Note that even though we recur there is no risk of
blowing stack because only list comparison recurses and by this point we have
ensured that the elements are not lists.
</p>

<p>
One might wonder why we're using <code>(string= ...)</code> to <a href="#coderef-compare hash tables"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-compare hash tables');" onmouseout="CodeHighlightOff(this, 'coderef-compare hash tables');">compare hash tables</a>. The
unsatisfying answer is that it was about 30% faster than whatever I could cook
up in Elisp.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/=</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>
<span id="coderef-strings-and-numbers" class="coderef-off">  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>stringp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>stringp Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span>string-equal X Y<span style="color: #709870;">)</span><span style="color: #909183;">)</span>  <span style="color: #8D8D84;">;;;</span> (strings-and-numbers)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>numberp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>numberp Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span>= X Y<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>symbolp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>symbolp Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span>eq X Y<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>t
<span id="coderef-obvious-equality-test" class="coderef-off">         <span style="color: #709870;">(</span><span style="color: #0000FF;">or</span> <span style="color: #907373;">(</span>equal X Y<span style="color: #907373;">)</span> <span style="color: #8D8D84;">;;;</span> (obvious-equality-test)</span>
             <span style="color: #907373;">(</span><span style="color: #0000FF;">cond</span>
              <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #0000FF;">and</span> <span style="color: #80A880;">(</span>consp X<span style="color: #80A880;">)</span> <span style="color: #80A880;">(</span>consp Y<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span><span style="color: #0000FF;">let</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>LengthX <span style="color: #707183;">(</span>safe-length X<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                     <span style="color: #887070;">(</span>LengthY <span style="color: #707183;">(</span>safe-length Y<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                 <span style="color: #80A880;">(</span><span style="color: #0000FF;">and</span>
                  <span style="color: #887070;">(</span>= LengthX LengthY<span style="color: #887070;">)</span>
                  <span style="color: #887070;">(</span><span style="color: #0000FF;">let</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>SoFar 't<span style="color: #7388D6;">)</span>
                        <span style="color: #7388D6;">(</span>InnerListsX <span style="color: #909183;">(</span>list X<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                        <span style="color: #7388D6;">(</span>InnerListsY <span style="color: #909183;">(</span>list Y<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                        <span style="color: #7388D6;">(</span>FirstTime 't<span style="color: #7388D6;">)</span>
                        <span style="color: #7388D6;">(</span>CurrentIndex <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                    <span style="color: #707183;">(</span><span style="color: #0000FF;">while</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> SoFar InnerListsX InnerListsY<span style="color: #7388D6;">)</span>
                      <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>CurrentListX <span style="color: #907373;">(</span><span style="color: #0000FF;">pop</span> InnerListsX<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                             <span style="color: #709870;">(</span>CurrentListY <span style="color: #907373;">(</span><span style="color: #0000FF;">pop</span> InnerListsY<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                             <span style="color: #709870;">(</span>Iterate
                              <span style="color: #907373;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #6276BA;">()</span>
                                <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>I <span style="color: #D0372D;">0</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                                  <span style="color: #858580;">(</span><span style="color: #0000FF;">while</span> <span style="color: #80A880;">(</span><span style="color: #0000FF;">and</span> SoFar <span style="color: #887070;">(</span>&lt; I LengthX<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                                    <span style="color: #80A880;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #887070;">(</span><span style="color: #707183;">(</span>CurrentX <span style="color: #7388D6;">(</span>nth I CurrentListX<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                                           <span style="color: #707183;">(</span>CurrentY <span style="color: #7388D6;">(</span>nth I CurrentListY<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                                      <span style="color: #887070;">(</span><span style="color: #0000FF;">cond</span>
<span id="coderef-elements are of the same type" class="coderef-off">                                       <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>not <span style="color: #909183;">(</span>equal <span style="color: #709870;">(</span>type-of CurrentX<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>type-of CurrentY<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #8D8D84;">;;;</span> (elements are of the same type)</span>
                                        <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> SoFar nil<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span id="coderef-store the inner list" class="coderef-off">                                       <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> <span style="color: #909183;">(</span>consp CurrentX<span style="color: #909183;">)</span> <span style="color: #909183;">(</span>consp CurrentY<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #8D8D84;">;;;</span> (store the inner list)</span>
                                        <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span>
                                          <span style="color: #909183;">(</span><span style="color: #0000FF;">push</span> CurrentX InnerListsX<span style="color: #909183;">)</span>
                                          <span style="color: #909183;">(</span><span style="color: #0000FF;">push</span> CurrentY InnerListsY<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span id="coderef-compare the elements" class="coderef-off">                                       <span style="color: #707183;">(</span>t <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> SoFar <span style="color: #909183;">(</span>shen/internal/= CurrentX CurrentY<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span> <span style="color: #8D8D84;">;;;</span> (compare the elements)</span>
                                      <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> I <span style="color: #707183;">(</span>1+ I<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
                        <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>not FirstTime<span style="color: #709870;">)</span>
                            <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
                              <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> FirstTime nil<span style="color: #907373;">)</span>
                              <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> LengthX <span style="color: #6276BA;">(</span>safe-length CurrentListX<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                              <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> LengthY <span style="color: #6276BA;">(</span>safe-length CurrentListY<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                              <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> SoFar <span style="color: #6276BA;">(</span>= LengthX LengthY<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                              <span style="color: #907373;">(</span>funcall Iterate<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                          <span style="color: #709870;">(</span>funcall Iterate<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                    SoFar<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
<span id="coderef-compare hash tables" class="coderef-off">              <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #0000FF;">and</span> <span style="color: #80A880;">(</span>hash-table-p X<span style="color: #80A880;">)</span> <span style="color: #80A880;">(</span>hash-table-p Y<span style="color: #80A880;">)</span><span style="color: #858580;">)</span> <span style="color: #8D8D84;">;;;</span> (compare hash tables)</span>
               <span style="color: #858580;">(</span><span style="color: #0000FF;">and</span> <span style="color: #80A880;">(</span>= <span style="color: #887070;">(</span>hash-table-count X<span style="color: #887070;">)</span> <span style="color: #887070;">(</span>hash-table-count Y<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
<span id="coderef-hash table comparison" class="coderef-off">                    <span style="color: #80A880;">(</span>string=  <span style="color: #8D8D84;">;;;</span> (hash table comparison)</span>
                     <span style="color: #887070;">(</span>prin1-to-string X<span style="color: #887070;">)</span>
                     <span style="color: #887070;">(</span>prin1-to-string Y<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
              <span style="color: #6276BA;">(</span>t nil<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/=</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>shen/internal/= X Y<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga46275c" class="outline-3">
<h3 id="orga46275c"><span class="section-number-3">2.11</span> Other Generic Functions</h3>
<div class="outline-text-3" id="text-2-11">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/freeze</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  `<span style="color: #7388D6;">(</span><span style="color: #0000FF;">function</span> <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> nil ,X<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/type</span> <span style="color: #7388D6;">(</span>X MyType<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">declare</span> <span style="color: #909183;">(</span>ignore MyType<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> X<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc69bed8" class="outline-3">
<h3 id="orgc69bed8"><span class="section-number-3">2.12</span> Lists</h3>
<div class="outline-text-3" id="text-2-12">
<p>
List construction in KLambda is done with <code>cons</code> exclusively. The KLambda list
<code>[ a b c ]</code> for example is constructed:
</p>
<pre class="example">
(cons a (cons b (cons c ())))
</pre>

<p>
Elisp also provides a <code>cons</code> so a straightforward translation is possible <b>but</b>
it blows the recursion stack after a certain number of elements. They are <a href="#org29f34f3">rewritten</a> to
<code>list</code> calls below but a <code>cons</code> is provided to adhere to the standard:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/cons</span> <span style="color: #7388D6;">(</span>A Rest<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>cons A Rest<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
The rest of the list operations function as expected:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/hd</span> <span style="color: #7388D6;">(</span>List<span style="color: #7388D6;">)</span>    <span style="color: #7388D6;">(</span>car List<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/tl</span> <span style="color: #7388D6;">(</span>List<span style="color: #7388D6;">)</span>    <span style="color: #7388D6;">(</span>cdr List<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/cons?</span> <span style="color: #7388D6;">(</span>List<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>consp List<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbcfdd2a" class="outline-3">
<h3 id="orgbcfdd2a"><span class="section-number-3">2.13</span> Strings</h3>
<div class="outline-text-3" id="text-2-13">
<ul class="org-ul">
<li><p>
Printing KLambda datatypes.
</p>

<p>
The only weirdness here is why we print the <code>buffer-name</code>
of a stream. That is explained in the <a href="#orgf023406">2.18</a>.:
</p></li>
</ul>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/str</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>null X<span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"null is not an atom in Shen; str cannot convert it to a string.~%"</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">or</span> <span style="color: #907373;">(</span>symbolp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>functionp X<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span>symbol-name X<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span>numberp X<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>number-to-string X<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span>stringp X<span style="color: #709870;">)</span> X<span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>bufferp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>buffer-file-name X<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span>buffer-name X<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span>eq X standard-input<span style="color: #709870;">)</span> <span style="color: #008000;">"standard-input"</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #709870;">(</span>eq X standard-output<span style="color: #709870;">)</span> <span style="color: #008000;">"standard-output"</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>t
         <span style="color: #709870;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #907373;">(</span>format <span style="color: #008000;">"%s is not an atom, stream or closure; str cannot convert it to a string."</span> X<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
<ul class="org-ul">
<li>Given string <code>S</code> get the character at index <code>N</code>:</li>
</ul>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/pos</span> <span style="color: #7388D6;">(</span>S N<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>string <span style="color: #909183;">(</span>aref S N<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<ul class="org-ul">
<li>Get the rest of a non-empty string:</li>
</ul>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/tlstr</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>substring X <span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<ul class="org-ul">
<li>Test for a string, join them and convert between characters and strings:</li>
</ul>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/string?</span> <span style="color: #7388D6;">(</span>S<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>stringp S<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/cn</span> <span style="color: #7388D6;">(</span>Str1 Str2<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>concat Str1 Str2<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/n-&gt;string</span> <span style="color: #7388D6;">(</span>N<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>string N<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/string-&gt;n</span> <span style="color: #7388D6;">(</span>S<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>string-to-char S<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
NOTE: If a non-empty string is converted to a character only the first character
of the string is considered.
</p>
</div>
</div>
<div id="outline-container-org32d5bd2" class="outline-3">
<h3 id="org32d5bd2"><span class="section-number-3">2.14</span> Error Handling</h3>
<div class="outline-text-3" id="text-2-14">
<p>
Elisp's <code>error</code> and <code>condition-case</code> covers the primitive error handling
required by the spec:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span>define-error 'shen/error <span style="color: #008000;">"Shen error"</span> 'error<span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/simple-error</span> <span style="color: #7388D6;">(</span>E<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #ff0000; font-weight: bold;">signal</span> 'shen/error
          <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>stringp E<span style="color: #709870;">)</span>
              <span style="color: #709870;">(</span>list E<span style="color: #709870;">)</span>
            E<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defmacro</span> <span style="color: #006699;">shen/trap-error</span> <span style="color: #7388D6;">(</span>X F<span style="color: #7388D6;">)</span>
  `<span style="color: #7388D6;">(</span><span style="color: #0000FF;">condition-case</span> ex ,X <span style="color: #909183;">(</span>'error <span style="color: #709870;">(</span>funcall ,F ex<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/error-to-string</span> <span style="color: #7388D6;">(</span>E<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>format <span style="color: #008000;">"%s"</span> E<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org79fade9" class="outline-3">
<h3 id="org79fade9"><span class="section-number-3">2.15</span> Vectors</h3>
<div class="outline-text-3" id="text-2-15">
<p>
Hash tables are used to represent Klambda vectors. This is counter-intuitive
since Elisp does have native vectors but unfortunately they are not resizable.
Since KLambda code tends to allocate huge vectors and resize often, switching
from vectors to hash-tables where resizing is natively supported led to 4-5x
speed-ups across the board.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/absvector</span> <span style="color: #7388D6;">(</span>N<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>make-hash-table <span style="color: #006FE0;">:size</span> N <span style="color: #006FE0;">:rehash-size</span> <span style="color: #D0372D;">3.0</span> <span style="color: #006FE0;">:test</span> 'shen/internal/hash-table-test<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/address-&gt;</span> <span style="color: #7388D6;">(</span>Vector N Value<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span> <span style="color: #909183;">(</span>puthash N Value Vector<span style="color: #909183;">)</span> Vector<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/&lt;-address</span> <span style="color: #7388D6;">(</span>Vector N<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>gethash N Vector<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/absvector?</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>hash-table-p X<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
While using hash-tables for Shen vectors, tuples and property lists do offer a
significant speed-ups there is an ugly downside: if any of those structures are
used as keys, lookups will fail because in Elisp two hash-tables do not hash to
the same number and so using <code>(make-hash-table ... :test 'equal)</code> does not work.
So we roll our own test which delegates to <code>shen/internal/=</code> for testing equality
and only generates a hash for these structures using only their keys and values.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span>define-hash-table-test
  'shen/internal/hash-table-test
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>X Y<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/internal/= X Y<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>X<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span>
     <span style="color: #709870;">(</span><span style="color: #907373;">(</span>numberp X<span style="color: #907373;">)</span> X<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #907373;">(</span>consp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>sxhash <span style="color: #6276BA;">(</span>prin1-to-string X<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #907373;">(</span>hash-table-p X<span style="color: #907373;">)</span>
      <span style="color: #907373;">(</span>sxhash <span style="color: #6276BA;">(</span>prin1-to-string X<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>t <span style="color: #907373;">(</span>sxhash X<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfb653f1" class="outline-3">
<h3 id="orgfb653f1"><span class="section-number-3">2.16</span> Arithmetic Operations</h3>
<div class="outline-text-3" id="text-2-16">
<p>
In KLambda there is only <code>number</code> so we have to take care to coerce to between <code>float</code> and
<code>integer</code> as necessary.
</p>

<p>
Most of this code is heavily borrowed from <a href="https://github.com/larsbrinkhoff/emacs-cl/blob/master/src/cl-numbers.el">emacs-cl</a> but simplified since Shen does not have
the zoo of numeric types supported by CL.
</p>

<p>
First a couple of limits to detect when a multiplication or addition might exceed the bounds
of an <code>integer</code>,
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defconst</span> <span style="color: #BA36A5;">shen/multiplication-limit</span> <span style="color: #7388D6;">(</span>floor <span style="color: #909183;">(</span>sqrt most-positive-fixnum<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defconst</span> <span style="color: #BA36A5;">shen/addition-limit</span> <span style="color: #7388D6;">(</span>floor <span style="color: #909183;">(</span>/ most-positive-fixnum <span style="color: #D0372D;">2</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
a generic function to coerce to a float if necessary,
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/number-op</span> <span style="color: #7388D6;">(</span>X Y max op<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span>
   <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>integerp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>integerp Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span><span style="color: #0000FF;">and</span> <span style="color: #6276BA;">(</span>&lt; X max<span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>&gt; X <span style="color: #858580;">(</span>- max<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>&lt; Y max<span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>&gt; Y <span style="color: #858580;">(</span>- max<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>apply op <span style="color: #6276BA;">(</span>list X Y<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
      <span style="color: #907373;">(</span>apply op <span style="color: #6276BA;">(</span>list <span style="color: #858580;">(</span>float X<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>float Y<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>floatp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>numberp Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span>apply op <span style="color: #907373;">(</span>list X <span style="color: #6276BA;">(</span>float Y<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>numberp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>floatp Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span>apply op <span style="color: #907373;">(</span>list <span style="color: #6276BA;">(</span>float X<span style="color: #6276BA;">)</span> Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span>t <span style="color: #709870;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #907373;">(</span>format <span style="color: #008000;">"Trying to %s. Both %s and %s must be numbers"</span> op X Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
and the standard arithmetic functions.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/*</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>shen/number-op X Y shen/multiplication-limit #'*<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/+</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>shen/number-op X Y shen/addition-limit #'+<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/-</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>shen/number-op X Y shen/addition-limit #'-<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
When we divide we leave the result an integer if we can:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen//</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span>
   <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">or</span> <span style="color: #907373;">(</span>not <span style="color: #6276BA;">(</span>numberp X<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> <span style="color: #907373;">(</span>not <span style="color: #6276BA;">(</span>numberp Y<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #709870;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #907373;">(</span>format <span style="color: #008000;">"Both %s and %s must be numbers."</span> X Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>integerp X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>integerp Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #709870;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>Div <span style="color: #858580;">(</span>/ <span style="color: #80A880;">(</span>float X<span style="color: #80A880;">)</span> <span style="color: #80A880;">(</span>float Y<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
           <span style="color: #6276BA;">(</span>Truncated <span style="color: #858580;">(</span>floor Div<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
      <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> <span style="color: #6276BA;">(</span>= Truncated Div<span style="color: #6276BA;">)</span>
          Truncated
        Div<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span>t <span style="color: #709870;">(</span>/ <span style="color: #907373;">(</span>float X<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>float Y<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
And finally the standard number predicates are pretty compatible with Elisp so we just
wrap the Elisp functions:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/&gt;</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>     <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>&gt; X Y<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/&lt;</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>     <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>&lt; X Y<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/&gt;=</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>    <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>&gt;= X Y<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/&lt;=</span> <span style="color: #7388D6;">(</span>X Y<span style="color: #7388D6;">)</span>    <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>&lt;= X Y<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/number?</span> <span style="color: #7388D6;">(</span>N<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>shen/internal/predicate-&gt;shen <span style="color: #909183;">(</span>numberp N<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfea81be" class="outline-3">
<h3 id="orgfea81be"><span class="section-number-3">2.17</span> Time</h3>
<div class="outline-text-3" id="text-2-17">
<p>
The <code>get-time</code> primitive given <code>real</code> or <code>unix</code> returns the current Unix time
(seconds since Jan 1st 1970) and given <code>run</code> returns the CPU time according to
Emacs.
</p>

<p>
Both Emacs functions <code>get-internal-run-time</code> and <code>current-time</code> return a 32-bit
number as a tuple where the first is the 16 high bits and the second is the 16
lower bits. To put them together we normalize the high bits by multiplying them
with 2^16 and add the result to the lower bits.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defconst</span> <span style="color: #BA36A5;">shen/2^16</span> <span style="color: #D0372D;">65536</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/get-time</span> <span style="color: #7388D6;">(</span>Time<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cl-flet</span>
      <span style="color: #909183;">(</span><span style="color: #709870;">(</span>timespec-to-number <span style="color: #907373;">(</span>spec<span style="color: #907373;">)</span>
                           <span style="color: #907373;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>high <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">0</span> spec<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                                  <span style="color: #858580;">(</span>low <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">1</span> spec<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                             <span style="color: #6276BA;">(</span>+ <span style="color: #858580;">(</span>* high shen/2^16<span style="color: #858580;">)</span> low<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>eq Time 'run<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>timespec-to-number <span style="color: #6276BA;">(</span>get-internal-run-time<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span>eq Time 'real<span style="color: #907373;">)(</span>timespec-to-number <span style="color: #6276BA;">(</span>current-time<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span><span style="color: #907373;">(</span>eq Time 'unix<span style="color: #907373;">)(</span>timespec-to-number <span style="color: #6276BA;">(</span>current-time<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
          <span style="color: #709870;">(</span>t <span style="color: #907373;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #6276BA;">(</span>format <span style="color: #008000;">"get-time does not understand parameter %s."</span> Time<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf023406" class="outline-3">
<h3 id="orgf023406"><span class="section-number-3">2.18</span> Streams and I/O</h3>
<div class="outline-text-3" id="text-2-18">
<p>
Streams at the KLambda level are just an abstraction over file I/O. At the Elisp
level <code>X</code> is a stream if it is a buffer with an associated file. That last bit
is important, because per the spec, buffers that aren't tied to the underlying
filesystem are not streams.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defsubst</span> <span style="color: #006699;">shen/streamp</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> <span style="color: #909183;">(</span>bufferp X<span style="color: #909183;">)</span> <span style="color: #909183;">(</span>buffer-file-name X<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Opening a stream takes a path <code>Path</code> and, per the spec, makes it relative to the
global <code>*home-directory*</code> variable. It also takes a <code>Direction</code> which is either
<code>in</code> or <code>out</code> meaning we are either reading or writing.
</p>

<p>
A file opened with <code>Direction</code> <code>in</code>, as in <code>(open some-file.txt in)</code> is
considered read-only. It must be opened with <code>Direction</code> <code>out</code>, as in <code>(open
some-file.txt out)</code> in order to be able to write to it. A read-only
file stream must be <code>close</code> -ed and re-opened <code>out</code> before it can be written.
</p>

<p>
Additionally buffers <code>open</code> -ed by Shen are "marked" with a buffer local variable
<code>shen/shen-buffer</code> to ensure that only Shen code can <code>read</code> / <code>write</code> / <code>close</code>
them. Buffers that are already open are left alone:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/open</span> <span style="color: #7388D6;">(</span>Path Direction<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>Path <span style="color: #907373;">(</span>concat <span style="color: #6276BA;">(</span>file-name-as-directory <span style="color: #858580;">(</span>shen/value '*home-directory*<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                       <span style="color: #6276BA;">(</span>file-relative-name Path<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>Buffer <span style="color: #907373;">(</span>find-buffer-visiting Path<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> Buffer
        <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">with-current-buffer</span> Buffer
            <span style="color: #6276BA;">(</span>goto-char <span style="color: #858580;">(</span>point-min<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          Buffer<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>equal Direction 'in<span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>not <span style="color: #80A880;">(</span>file-exists-p Path<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #80A880;">(</span>format <span style="color: #008000;">"Path does not exist: %s"</span> Path<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">progn</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> Buffer <span style="color: #887070;">(</span>find-file-noselect Path<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">with-current-buffer</span>
                Buffer
              <span style="color: #887070;">(</span><span style="color: #0000FF;">progn</span>
                <span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> buffer-read-only 't<span style="color: #707183;">)</span>
                <span style="color: #707183;">(</span><span style="color: #0000FF;">setq-local</span> shen/shen-buffer 't<span style="color: #707183;">)</span>
                <span style="color: #707183;">(</span>goto-char <span style="color: #7388D6;">(</span>point-min<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
            Buffer<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>equal Direction 'out<span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> Buffer <span style="color: #80A880;">(</span>find-buffer-visiting Path<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> <span style="color: #80A880;">(</span>bufferp Buffer<span style="color: #80A880;">)</span>
              <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> <span style="color: #887070;">(</span><span style="color: #0000FF;">and</span> <span style="color: #707183;">(</span>buffer-local-value 'buffer-read-only Buffer<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>buffer-local-value 'shen/shen-buffer Buffer<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                  <span style="color: #887070;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #707183;">(</span>format  <span style="color: #008000;">"A stream to %s already open read-only. Call (close \"%s\") followed by (open \"%s\" 'out). "</span> Path Path Path<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                Buffer<span style="color: #80A880;">)</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> Buffer <span style="color: #707183;">(</span>find-file-noselect Path<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">with-current-buffer</span> Buffer
                <span style="color: #707183;">(</span><span style="color: #0000FF;">progn</span>
                  <span style="color: #7388D6;">(</span>goto-char <span style="color: #909183;">(</span>point-max<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq-local</span> shen/shen-buffer 't<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<ul class="org-ul">
<li>Before closing, reading or writing to a buffer first check that it was opened by
a Shen program.</li>
</ul>

<p>
A further bit of weirdness is that <code>write-byte</code> switches on a <a href="#coderef-write-byte-function"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-write-byte-function');" onmouseout="CodeHighlightOff(this, 'coderef-write-byte-function');">function</a>. This is because
when writing out to the <a href="#org7cf0e03">10</a> requires calling a function with the character.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/close</span> <span style="color: #7388D6;">(</span>Stream<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>not Stream<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #008000;">"Stream is nil."</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>local-variable-p 'shen/shen-buffer Stream<span style="color: #907373;">)</span>
             <span style="color: #907373;">(</span>buffer-local-value 'shen/shen-buffer Stream<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>buffer-local-value 'buffer-read-only Stream<span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span>kill-buffer Stream<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
              <span style="color: #907373;">(</span>t <span style="color: #6276BA;">(</span><span style="color: #0000FF;">with-current-buffer</span>
                     Stream
                   <span style="color: #858580;">(</span><span style="color: #0000FF;">progn</span>
                     <span style="color: #80A880;">(</span>write-file <span style="color: #887070;">(</span>buffer-file-name Stream<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                     <span style="color: #80A880;">(</span>kill-buffer Stream<span style="color: #80A880;">)</span>
                     '<span style="color: #80A880;">()</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/write-byte</span> <span style="color: #7388D6;">(</span>Byte <span style="color: #6434A3;">&amp;optional</span> S<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> S
      <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span>
       <span style="color: #709870;">(</span><span style="color: #907373;">(</span>bufferp S<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> <span style="color: #6276BA;">(</span>not <span style="color: #858580;">(</span>local-variable-p 'buffer-read-only S<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #858580;">(</span>format <span style="color: #008000;">"Buffer %s is read-only."</span> S<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>buffer-local-value 'shen/shen-buffer S<span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span>write-char Byte S<span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #80A880;">(</span>format <span style="color: #008000;">"Buffer %s was not opened by Shen."</span> S<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
<span id="coderef-write-byte-function" class="coderef-off">       <span style="color: #709870;">(</span><span style="color: #907373;">(</span>functionp S<span style="color: #907373;">)</span> <span style="color: #8D8D84;">;;</span> (write-byte-function)</span>
        <span style="color: #907373;">(</span>funcall S Byte<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
       <span style="color: #709870;">(</span>t <span style="color: #907373;">(</span>write-char <span style="color: #6276BA;">(</span>shen/stoutput<span style="color: #6276BA;">)</span> Byte<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>funcall <span style="color: #709870;">(</span>shen/stoutput<span style="color: #709870;">)</span> Byte<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/read-byte</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">&amp;optional</span> S<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span>
   <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>bufferp S<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>buffer-file-name S<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #709870;">(</span><span style="color: #0000FF;">with-current-buffer</span> S
      <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>current-byte<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>eq <span style="color: #80A880;">(</span>point<span style="color: #80A880;">)</span> <span style="color: #80A880;">(</span>point-max<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #D0372D;">-1</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">progn</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> current-byte <span style="color: #887070;">(</span>get-byte<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
            <span style="color: #80A880;">(</span>forward-char<span style="color: #80A880;">)</span>
            current-byte<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #709870;">(</span>vectorp S<span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>not <span style="color: #6276BA;">(</span>aref S <span style="color: #D0372D;">0</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                    <span style="color: #D0372D;">-1</span>
                  <span style="color: #907373;">(</span><span style="color: #0000FF;">pop</span> <span style="color: #6276BA;">(</span>aref S <span style="color: #D0372D;">0</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span>t <span style="color: #709870;">(</span><span style="color: #ff0000; font-weight: bold;">error</span> <span style="color: #907373;">(</span>format <span style="color: #008000;">"Unrecognized stream format %s"</span> S<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf93b424" class="outline-2">
<h2 id="orgf93b424"><span class="section-number-2">3</span> Utilities</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-orgf9ca75c" class="outline-3">
<h3 id="orgf9ca75c"><span class="section-number-3">3.1</span> Lookup</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/lookup-with-default</span> <span style="color: #7388D6;">(</span>KEY ALIST DEFAULT<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>car <span style="color: #909183;">(</span><span style="color: #0000FF;">or</span> <span style="color: #709870;">(</span>assoc-default KEY ALIST<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>list DEFAULT<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org2d7f67d" class="outline-3">
<h3 id="org2d7f67d"><span class="section-number-3">3.2</span> AST Utilities</h3>
<div class="outline-text-3" id="text-3-2">
<p>
The next few sections are about transforming the KLambda AST so we
need a few utilites to make the job easier.
</p>
</div>
<div id="outline-container-org1fede55" class="outline-4">
<h4 id="org1fede55"><span class="section-number-4">3.2.1</span> Paths</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
Paths are a way of getting or setting deep inside some tree. For the most part
they are a list of numbers . A getter to the path <code>'(0 4 3)</code> given an <code>ast</code>
simply folds over the list into <code>(nth 0 (nth 4 (nth 3 ast)))</code>.
</p>

<p>
Unfortunately the presence of dotted pairs makes the representation less
uniform. Using <code>nth</code> does not get and set the cdr of a dotted pair. For example,
<code>(nth 1 '(a . b))</code> will throw an error about <code>b</code> not being a list. In that case
we need to use <code>(nthcdr 1 '(a . b))</code>. The <code>cdr</code> of a dotted pair is represented
as a single number <code>1</code> inside a list, like <code>'(1)</code>.
</p>
</div>
</div>

<div id="outline-container-org08564fd" class="outline-4">
<h4 id="org08564fd"><span class="section-number-4">3.2.2</span> AST Getter/Setter</h4>
<div class="outline-text-4" id="text-3-2-2">
<div class="org-src-container">
<pre class="src src-elisp" id="org371004f"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/get-element-at</span> <span style="color: #7388D6;">(</span>path ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>res ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #709870;">(</span>current-index <span style="color: #907373;">(</span>reverse path<span style="color: #907373;">)</span> res<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>listp current-index<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> res <span style="color: #6276BA;">(</span>nthcdr <span style="color: #858580;">(</span>car current-index<span style="color: #858580;">)</span> res<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> res <span style="color: #6276BA;">(</span>nth current-index res<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
For the setter we use Elisp's <code>setf</code> which takes a <code>PLACE</code> expression and a
value. Given the previous example path <code>(0 4 3)</code> , <code>(setf (nth 0 (nth 4 (nth
3 ast))) 'x)</code> changes the 1st element of the 3rd element of the 2nd element to
<code>'x</code>. This function is more complex because unlike the getter we can't just
iterate down the tree, we have to <i>build</i> the <code>PLACE</code> expression completely
before handing it off to <code>setf</code>.
</p>
<div class="org-src-container">
<pre class="src src-elisp" id="orga8e0e8d"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/nset-element-at</span> <span style="color: #7388D6;">(</span>path ast new-element<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>not path<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #0000FF;">setf</span> ast new-element<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>place-fn<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>path <span style="color: #6276BA;">(</span>reverse path<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>make-place-fn
           <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>path target<span style="color: #858580;">)</span>
             <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> <span style="color: #80A880;">(</span>listp path<span style="color: #80A880;">)</span>
                 `<span style="color: #80A880;">(</span>nthcdr ,path ,target<span style="color: #80A880;">)</span>
                 `<span style="color: #80A880;">(</span>nth ,path ,target<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">dotimes</span> <span style="color: #6276BA;">(</span>current-index <span style="color: #858580;">(</span>length path<span style="color: #858580;">)</span> nil<span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> place-fn
                <span style="color: #858580;">(</span>funcall make-place-fn
                         <span style="color: #80A880;">(</span>nth current-index path<span style="color: #80A880;">)</span>
                         <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> <span style="color: #887070;">(</span>= current-index <span style="color: #D0372D;">0</span><span style="color: #887070;">)</span>
                             'ast
                           place-fn<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> <span style="color: #6276BA;">(</span><span style="color: #0000FF;">or</span> <span style="color: #858580;">(</span>consp new-element<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>shen/symbol-p new-element<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>eval `<span style="color: #858580;">(</span><span style="color: #0000FF;">setf</span> ,place-fn <span style="color: #80A880;">(</span><span style="color: #0000FF;">quote</span> ,new-element<span style="color: #80A880;">)</span><span style="color: #858580;">)</span> 't<span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span>eval `<span style="color: #858580;">(</span><span style="color: #0000FF;">setf</span> ,place-fn ,new-element<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> 't<span style="color: #907373;">)</span>
        ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb29fa7a" class="outline-4">
<h4 id="orgb29fa7a"><span class="section-number-4">3.2.3</span> AST Search</h4>
<div class="outline-text-4" id="text-3-2-3">
</div><ol class="org-ol"><li><a id="orgde17cd2"></a>Find All<br  /><div class="outline-text-5" id="text-3-2-3-1">
<p>
Search the tree and return paths to all the elements that are <code>equal</code> to the given <code>X</code>.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/find-all</span> <span style="color: #7388D6;">(</span>X ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span>consp ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      'shen/not-found
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>lists-left-to-search `<span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #80A880;">()</span> ,ast<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>found 'shen/not-found<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">while</span> lists-left-to-search
        <span style="color: #907373;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>search-candidate <span style="color: #80A880;">(</span>car lists-left-to-search<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>search-candidate-path <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">0</span> search-candidate<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>current-list <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">1</span> search-candidate<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> lists-left-to-search <span style="color: #80A880;">(</span>cdr lists-left-to-search<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">dotimes</span> <span style="color: #80A880;">(</span>current-index <span style="color: #887070;">(</span>length current-list<span style="color: #887070;">)</span> nil<span style="color: #80A880;">)</span>
              <span style="color: #80A880;">(</span><span style="color: #0000FF;">let</span> <span style="color: #887070;">(</span><span style="color: #707183;">(</span>current-element <span style="color: #7388D6;">(</span>nth current-index current-list<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                    <span style="color: #707183;">(</span>current-path <span style="color: #7388D6;">(</span>cons current-index search-candidate-path<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                <span style="color: #887070;">(</span><span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span>equal X current-element<span style="color: #707183;">)</span>
                    <span style="color: #707183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>consp found<span style="color: #7388D6;">)</span>
                        <span style="color: #7388D6;">(</span><span style="color: #0000FF;">push</span> current-path found<span style="color: #7388D6;">)</span>
                      <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> found <span style="color: #909183;">(</span>list current-path<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                  <span style="color: #707183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>consp current-element<span style="color: #7388D6;">)</span>
                      <span style="color: #7388D6;">(</span><span style="color: #0000FF;">push</span> `<span style="color: #909183;">(</span>,current-path ,current-element<span style="color: #909183;">)</span>
                            lists-left-to-search<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      found<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div></li>
<li><a id="orge290b48"></a>Find Containing List<br  /><div class="outline-text-5" id="text-3-2-3-2">
<p>
In addition to accessing and modifying an element given a path we also need
a function that finds the list that contains an element. This following function,
given an element <code>X</code>, a predicate function that takes <b>a list</b> that might contain
the element and an <code>ast</code>, returns a path to <b>the list</b> containing that element
not a path to the element itself.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/list-containing-first-occurrence-of</span> <span style="color: #7388D6;">(</span>list-pred ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span>consp ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      'shen/not-found
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>lists-left-to-search `<span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #80A880;">()</span> ,ast<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>found 'shen/not-found<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">while</span> <span style="color: #6276BA;">(</span><span style="color: #0000FF;">and</span> lists-left-to-search <span style="color: #858580;">(</span>eq found 'shen/not-found<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>search-candidate <span style="color: #887070;">(</span>car lists-left-to-search<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                 <span style="color: #80A880;">(</span>search-candidate-path <span style="color: #887070;">(</span>nth <span style="color: #D0372D;">0</span> search-candidate<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                 <span style="color: #80A880;">(</span>current-list <span style="color: #887070;">(</span>nth <span style="color: #D0372D;">1</span> search-candidate<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                 <span style="color: #80A880;">(</span>current-list-length <span style="color: #887070;">(</span>length current-list<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> <span style="color: #80A880;">(</span>funcall list-pred current-list<span style="color: #80A880;">)</span>
                <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> found search-candidate-path<span style="color: #80A880;">)</span>
              <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
                <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> lists-left-to-search
                      <span style="color: #707183;">(</span>append
                       <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>reversed-lists-in-current-list<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
                         <span style="color: #909183;">(</span><span style="color: #0000FF;">dotimes</span> <span style="color: #709870;">(</span>current-index current-list-length <span style="color: #907373;">(</span>reverse reversed-lists-in-current-list<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                           <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>consp <span style="color: #6276BA;">(</span>nth current-index current-list<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                               <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> reversed-lists-in-current-list
                                     <span style="color: #6276BA;">(</span>cons <span style="color: #858580;">(</span>list <span style="color: #80A880;">(</span>cons current-index search-candidate-path<span style="color: #80A880;">)</span>
                                                 <span style="color: #80A880;">(</span>nth current-index current-list<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                                           reversed-lists-in-current-list<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                       <span style="color: #7388D6;">(</span>cdr lists-left-to-search<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        found<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div></li></ol>
</div>
<div id="outline-container-org01abc05" class="outline-4">
<h4 id="org01abc05"><span class="section-number-4">3.2.4</span> Path Utilities</h4>
<div class="outline-text-4" id="text-3-2-4">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/get-path-relative-to</span> <span style="color: #7388D6;">(</span>parent-path path<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> <span style="color: #909183;">(</span>shen/internal/starts-with-path parent-path path<span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>shen/internal/path-slice path <span style="color: #D0372D;">0</span> <span style="color: #709870;">(</span>- <span style="color: #907373;">(</span>length path<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>length parent-path<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/starts-with-path</span> <span style="color: #7388D6;">(</span>parent-path path<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> <span style="color: #909183;">(</span>&lt;= <span style="color: #709870;">(</span>length parent-path<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>length path<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>equal parent-path
              <span style="color: #709870;">(</span>shen/internal/path-slice path
                                        <span style="color: #907373;">(</span>- <span style="color: #6276BA;">(</span>length path<span style="color: #6276BA;">)</span>
                                           <span style="color: #6276BA;">(</span>length parent-path<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/get-path-parent</span> <span style="color: #7388D6;">(</span>path<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>cdr path<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/path-slice</span> <span style="color: #7388D6;">(</span>path start <span style="color: #6434A3;">&amp;optional</span> end<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>start-to-end <span style="color: #907373;">(</span>nthcdr start path<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>res<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> end
        <span style="color: #709870;">(</span><span style="color: #0000FF;">dotimes</span> <span style="color: #907373;">(</span>i <span style="color: #6276BA;">(</span>- <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> <span style="color: #80A880;">(</span>&lt; end <span style="color: #887070;">(</span>length path<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                           end
                         <span style="color: #80A880;">(</span>length path<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                       start<span style="color: #6276BA;">)</span>
                    <span style="color: #6276BA;">(</span>nreverse res<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">push</span> <span style="color: #6276BA;">(</span>nth i start-to-end<span style="color: #6276BA;">)</span> res<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      start-to-end<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org95a33fd" class="outline-4">
<h4 id="org95a33fd"><span class="section-number-4">3.2.5</span> AST Modification</h4>
<div class="outline-text-4" id="text-3-2-5">
<p>
Given an <code>ast</code>, some <code>paths</code>, destructively modify the ast with <code>tx-fn</code>. Note
that it starts with the deepest path first so as not to invalidate paths further
up the code tree.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/modify-ast</span> <span style="color: #7388D6;">(</span>ast paths tx-fn<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>deepest-first <span style="color: #907373;">(</span>sort paths <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>A B<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>&gt; <span style="color: #80A880;">(</span>length A<span style="color: #80A880;">)</span> <span style="color: #80A880;">(</span>length B<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>current-ast ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #709870;">(</span>path deepest-first current-ast<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">setq</span> current-ast
            <span style="color: #907373;">(</span>shen/internal/nset-element-at path ast <span style="color: #6276BA;">(</span>funcall tx-fn path ast<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc18f8b2" class="outline-3">
<h3 id="orgc18f8b2"><span class="section-number-3">3.3</span> List</h3>
<div class="outline-text-3" id="text-3-3">
</div><div id="outline-container-org43887e7" class="outline-4">
<h4 id="org43887e7"><span class="section-number-4">3.3.1</span> Detect Dotted Pair</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
Note this only detects dotted pairs that look like <code>'(a . b)</code>, not ones
that look like <code>'(a b c . d)</code>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/dotted-pair?</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> <span style="color: #909183;">(</span>consp X<span style="color: #909183;">)</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span>consp <span style="color: #907373;">(</span>cdr X<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org88789e5" class="outline-4">
<h4 id="org88789e5"><span class="section-number-4">3.3.2</span> List Filtering</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
A partition function that returns a pair of lists where
the first holds elements that pass and the second holds
those that fail:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/partition</span> <span style="color: #7388D6;">(</span>pred Xs<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>a<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>b<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">dotimes</span> <span style="color: #709870;">(</span>i <span style="color: #907373;">(</span>length Xs<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>list a b<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">push</span> <span style="color: #907373;">(</span>nth i Xs<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> <span style="color: #6276BA;">(</span>funcall pred <span style="color: #858580;">(</span>nth i Xs<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> a b<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
A filter function that returns the elements of <code>Xs</code> for which
<code>pred</code> holds but also optionally includes their index:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/filter</span> <span style="color: #7388D6;">(</span>pred Xs <span style="color: #6434A3;">&amp;optional</span> include-index<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>accum<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">dotimes</span> <span style="color: #709870;">(</span>i <span style="color: #907373;">(</span>length Xs<span style="color: #907373;">)</span> accum<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>funcall pred <span style="color: #6276BA;">(</span>nth i Xs<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">push</span> <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> include-index
                    <span style="color: #858580;">(</span>list <span style="color: #80A880;">(</span>nth i Xs<span style="color: #80A880;">)</span> i<span style="color: #858580;">)</span>
                  <span style="color: #858580;">(</span>nth i Xs<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                accum<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
A list search function that returns the index of the first
element for which <code>pred</code> holds:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/index-of</span> <span style="color: #7388D6;">(</span>pred Xs<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>found<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>index <span style="color: #D0372D;">0</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">while</span> <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>not found<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>&lt; index <span style="color: #6276BA;">(</span>length Xs<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> <span style="color: #6276BA;">(</span>funcall pred <span style="color: #858580;">(</span>nth index Xs<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> found index<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> index <span style="color: #6276BA;">(</span>+ index <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    found<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
A function that deletes the first occurrences of X
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/delete-first-eq</span> <span style="color: #7388D6;">(</span>needle Xs<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>index <span style="color: #907373;">(</span>shen/internal/index-of <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>X<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>eq X needle<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> Xs<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> index
        <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>current-index <span style="color: #D0372D;">0</span><span style="color: #6276BA;">)</span>
              <span style="color: #6276BA;">(</span>copy<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">while</span> <span style="color: #6276BA;">(</span>&lt; current-index <span style="color: #858580;">(</span>length Xs<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> <span style="color: #80A880;">(</span>not <span style="color: #887070;">(</span>= current-index index<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span><span style="color: #0000FF;">push</span> <span style="color: #887070;">(</span>nth current-index Xs<span style="color: #887070;">)</span> copy<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #80A880;">(</span>1+ current-index<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>nreverse copy<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      Xs<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb538ab3" class="outline-2">
<h2 id="orgb538ab3"><span class="section-number-2">4</span> Rewriting The AST</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-org8ffa5f1" class="outline-3">
<h3 id="org8ffa5f1"><span class="section-number-3">4.1</span> Walking The AST</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Before evaluating we walk the tree and return locations that require:
</p>
<ul class="org-ul">
<li><a href="#coderef-namespace-only"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-namespace-only');" onmouseout="CodeHighlightOff(this, 'coderef-namespace-only');">namespace-only</a> : paths that need prefixing with <code>shen/</code>,</li>
<li><a href="#coderef-quote-only"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-quote-only');" onmouseout="CodeHighlightOff(this, 'coderef-quote-only');">quote-only</a> : paths that need quoting only (since KLambda symbols do not need it but Elisp does)</li>
<li><a href="#coderef-possibly-apply-function"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-possibly-apply-function');" onmouseout="CodeHighlightOff(this, 'coderef-possibly-apply-function');">possibly-apply-function</a> : a list of <b>pairs</b> consisting of a path to the function at
the head of the call and a list of symbols that have been passed in or bound via <code>let</code>.</li>
</ul>

<p>
Internal to the walker, as each sublist is processed the following are tracked:
</p>
<ul class="org-ul">
<li><a href="#coderef-current-path"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-current-path');" onmouseout="CodeHighlightOff(this, 'coderef-current-path');">current-path</a> The path from root to the current point in the tree</li>
<li><a href="#coderef-current-list"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-current-list');" onmouseout="CodeHighlightOff(this, 'coderef-current-list');">current-list</a> The list currently being walked.</li>
<li><a href="#coderef-current-list-length"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-current-list-length');" onmouseout="CodeHighlightOff(this, 'coderef-current-list-length');">current-list-length</a> The length of the current list</li>
<li><a href="#coderef-current-index"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-current-index');" onmouseout="CodeHighlightOff(this, 'coderef-current-index');">current-index</a> The index of the current element in the current list.</li>
<li><a href="#coderef-locally-scoped-symbols"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-locally-scoped-symbols');" onmouseout="CodeHighlightOff(this, 'coderef-locally-scoped-symbols');">locally-scoped-symbols</a> A list of symbols local to the current list
that, when encountered, should remain unchanged since they were either passed
in or bound via <code>let</code>.</li>
<li><a href="#coderef-inner-lists"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-inner-lists');" onmouseout="CodeHighlightOff(this, 'coderef-inner-lists');">inner-lists</a> If a list is encountered when iterating over the current one,
a path to that list and the set of symbols currently in scope are stored.
Each inner list is processed in turn (possibly adding more). Iteration of the AST
is over when there are no more inner lists left.</li>
</ul>

<p>
While iterating over a list the following cases are encountered:
</p>
<ul class="org-ul">
<li><p>
At the head of the list non- <code>nil</code> symbols need prefixing and quoting. Additionally:
</p>
<ul class="org-ul">
<li>if it is a <a href="#coderef-lambda form"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-lambda form');" onmouseout="CodeHighlightOff(this, 'coderef-lambda form');">lambda form</a>, the argument is added to the list of locally scoped variables
and iteration moves to the body.</li>
<li>if we're looking at a <a href="#coderef-defun form"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-defun form');" onmouseout="CodeHighlightOff(this, 'coderef-defun form');">defun form</a>, the second element of the
form does not get quoted since it is the name of the function,
and the arguments are added to local scope. before moving on to the
body.</li>
<li>if it is a <a href="#coderef-let form"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-let form');" onmouseout="CodeHighlightOff(this, 'coderef-let form');">let form</a>, the name of the assignment is added to local scope and
iteration moves to the assignment body.</li>
<li>any forms seen inside a <a href="#coderef-cond form"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-cond form');" onmouseout="CodeHighlightOff(this, 'coderef-cond form');">cond form</a> have to be treated differently. Specifically
a symbol at the head of a predicate action pair is not function application so
a <a href="#coderef-inner-lists-in-cond-form"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-inner-lists-in-cond-form');" onmouseout="CodeHighlightOff(this, 'coderef-inner-lists-in-cond-form');">special flag</a> is required to indicate that when iterating over the rest of a
<code>cond</code> form.</li>
<li>otherwise it is a function call, and the path is stored along with the symbols in
scope thus far.</li>
</ul>
<p>
Symbols occuring anywhere else in the list are only quoted, not namespaced since they are not
functions calls. They might be variables, but <code>shen/get</code> and <code>shen/set</code> take care of prefixing
them so there's no need to worry about them here.
</p></li>
<li>All sublists encountered are stored for further processing. If they are at the head of the list
and not part of <code>cond</code>, they are also possible function calls.</li>
</ul>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/get-function-symbol-and-funcall-paths</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
<span id="coderef-namespace-only" class="coderef-off">  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>namespace-only<span style="color: #709870;">)</span>        <span style="color: #8D8D84;">;;</span> (namespace-only)</span>
<span id="coderef-quote-only" class="coderef-off">        <span style="color: #709870;">(</span>quote-only<span style="color: #709870;">)</span>            <span style="color: #8D8D84;">;;</span> (quote-only)</span>
<span id="coderef-possibly-apply-function" class="coderef-off">        <span style="color: #709870;">(</span>possibly-apply-function<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #8D8D84;">;;</span> (possibly-apply-function)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>not <span style="color: #907373;">(</span>consp ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>shen/symbol-p ast<span style="color: #907373;">)</span>
            <span style="color: #907373;">(</span>list nil '<span style="color: #6276BA;">(</span>nil<span style="color: #6276BA;">)</span> '<span style="color: #6276BA;">(</span>nil<span style="color: #6276BA;">)</span> nil nil<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>list nil nil nil nil nil<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
<span id="coderef-current-path" class="coderef-off">      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>current-path<span style="color: #6276BA;">)</span>                     <span style="color: #8D8D84;">;;</span> (current-path)</span>
<span id="coderef-current-list" class="coderef-off">            <span style="color: #6276BA;">(</span>current-list ast<span style="color: #6276BA;">)</span>                 <span style="color: #8D8D84;">;;</span> (current-list)</span>
<span id="coderef-current-list-length" class="coderef-off">            <span style="color: #6276BA;">(</span>current-list-length <span style="color: #858580;">(</span>length ast<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> <span style="color: #8D8D84;">;;</span> (current-list-length)</span>
<span id="coderef-current-index" class="coderef-off">            <span style="color: #6276BA;">(</span>current-index <span style="color: #D0372D;">0</span><span style="color: #6276BA;">)</span>                  <span style="color: #8D8D84;">;;</span> (current-index)</span>
<span id="coderef-locally-scoped-symbols" class="coderef-off">            <span style="color: #6276BA;">(</span>locally-scoped-symbols<span style="color: #6276BA;">)</span>           <span style="color: #8D8D84;">;;</span> (locally-scoped-symbols)</span>
<span id="coderef-inner-lists" class="coderef-off">            <span style="color: #6276BA;">(</span>inner-lists<span style="color: #6276BA;">)</span>                      <span style="color: #8D8D84;">;;</span> (inner-lists)</span>
            <span style="color: #6276BA;">(</span>cond-predicate-action-p<span style="color: #6276BA;">)</span>
<span id="coderef-inner-lists-in-cond-form" class="coderef-off">            <span style="color: #6276BA;">(</span>inner-lists-in-cond-form<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>        <span style="color: #8D8D84;">;;</span> (inner-lists-in-cond-form)</span>
<span id="coderef-continue iterating" class="coderef-off">        <span style="color: #907373;">(</span><span style="color: #0000FF;">while</span> <span style="color: #6276BA;">(</span><span style="color: #0000FF;">or</span> <span style="color: #858580;">(</span>&lt; current-index current-list-length<span style="color: #858580;">)</span> <span style="color: #8D8D84;">;;</span> (continue iterating)</span>
                   inner-lists<span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">cond</span>
<span id="coderef-sublists left" class="coderef-off">           <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #0000FF;">and</span> <span style="color: #887070;">(</span>= current-index current-list-length<span style="color: #887070;">)</span> inner-lists<span style="color: #80A880;">)</span> <span style="color: #8D8D84;">;;</span> (sublists left)</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> locally-scoped-symbols <span style="color: #707183;">(</span>nth <span style="color: #D0372D;">0</span> <span style="color: #7388D6;">(</span>car inner-lists<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> current-path <span style="color: #707183;">(</span>nth <span style="color: #D0372D;">1</span> <span style="color: #7388D6;">(</span>car inner-lists<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> cond-predicate-action-p <span style="color: #707183;">(</span>nth <span style="color: #D0372D;">2</span> <span style="color: #7388D6;">(</span>car inner-lists<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> inner-lists-in-cond-form nil<span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> inner-lists <span style="color: #707183;">(</span>cdr inner-lists<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> current-list <span style="color: #707183;">(</span>shen/internal/get-element-at current-path ast<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #D0372D;">0</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> current-list-length <span style="color: #707183;">(</span>length current-list<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
<span id="coderef-not a list" class="coderef-off">           <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #0000FF;">and</span> <span style="color: #887070;">(</span>&lt; current-index current-list-length<span style="color: #887070;">)</span>              <span style="color: #8D8D84;">;;</span> (not a list)</span>
                 <span style="color: #887070;">(</span>not <span style="color: #707183;">(</span>consp <span style="color: #7388D6;">(</span>nth current-index current-list<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">let</span> <span style="color: #887070;">(</span><span style="color: #707183;">(</span>current-token <span style="color: #7388D6;">(</span>nth current-index current-list<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span>= <span style="color: #D0372D;">0</span> current-index<span style="color: #707183;">)</span>
                  <span style="color: #707183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span>eq current-token 'nil<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
                           <span style="color: #909183;">(</span>shen/symbol-p current-token<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                      <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span>
                        <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>not <span style="color: #6276BA;">(</span>memq current-token locally-scoped-symbols<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                                 <span style="color: #907373;">(</span>not <span style="color: #6276BA;">(</span>eq current-token 'defun<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                            <span style="color: #709870;">(</span><span style="color: #0000FF;">push</span> <span style="color: #907373;">(</span>cons <span style="color: #D0372D;">0</span> current-path<span style="color: #907373;">)</span>
                                  namespace-only<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
                        <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span>
                         <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #0000FF;">or</span> <span style="color: #6276BA;">(</span>eq current-token 'lambda<span style="color: #6276BA;">)</span>
<span id="coderef-lambda form" class="coderef-off">                              <span style="color: #6276BA;">(</span>eq current-token 'shen/lambda<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> <span style="color: #8D8D84;">;;</span> (lambda form)</span>
                          <span style="color: #907373;">(</span><span style="color: #0000FF;">progn</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">push</span> <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #858580;">)</span> locally-scoped-symbols<span style="color: #6276BA;">)</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #D0372D;">2</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
<span id="coderef-defun form" class="coderef-off">                         <span style="color: #709870;">(</span><span style="color: #907373;">(</span>eq current-token 'defun<span style="color: #907373;">)</span> <span style="color: #8D8D84;">;;</span> (defun form)</span>
                          <span style="color: #907373;">(</span><span style="color: #0000FF;">progn</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">push</span> <span style="color: #858580;">(</span>cons <span style="color: #D0372D;">1</span> current-path<span style="color: #858580;">)</span> namespace-only<span style="color: #6276BA;">)</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> locally-scoped-symbols
                                  <span style="color: #858580;">(</span>append <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">2</span> current-list<span style="color: #80A880;">)</span> locally-scoped-symbols<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #D0372D;">3</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                         <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #0000FF;">or</span> <span style="color: #6276BA;">(</span>eq current-token 'let<span style="color: #6276BA;">)</span>
<span id="coderef-let form" class="coderef-off">                              <span style="color: #6276BA;">(</span>eq current-token 'shen/let<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>  <span style="color: #8D8D84;">;;</span> (let form)</span>
                          <span style="color: #907373;">(</span><span style="color: #0000FF;">progn</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">push</span> <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #858580;">)</span> locally-scoped-symbols<span style="color: #6276BA;">)</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #D0372D;">2</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                         <span style="color: #709870;">(</span><span style="color: #907373;">(</span><span style="color: #0000FF;">or</span> <span style="color: #6276BA;">(</span>eq current-token 'cond<span style="color: #6276BA;">)</span>
<span id="coderef-cond form" class="coderef-off">                              <span style="color: #6276BA;">(</span>eq current-token 'shen/cond<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> <span style="color: #8D8D84;">;;</span> (cond form)</span>
                          <span style="color: #907373;">(</span><span style="color: #0000FF;">progn</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> inner-lists-in-cond-form 't<span style="color: #6276BA;">)</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                         <span style="color: #709870;">(</span>t
                          <span style="color: #907373;">(</span><span style="color: #0000FF;">progn</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>not cond-predicate-action-p<span style="color: #858580;">)</span>
                                <span style="color: #858580;">(</span><span style="color: #0000FF;">push</span> <span style="color: #80A880;">(</span>list <span style="color: #887070;">(</span>cons <span style="color: #D0372D;">0</span> current-path<span style="color: #887070;">)</span>
                                            <span style="color: #887070;">(</span>memq current-token locally-scoped-symbols<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                                      possibly-apply-function<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                    <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #909183;">(</span>1+ current-index<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                <span style="color: #707183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">and</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span>eq current-token 'nil<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
                         <span style="color: #909183;">(</span>shen/symbol-p current-token<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                    <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span>
                      <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>not <span style="color: #907373;">(</span>memq current-token locally-scoped-symbols<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                          <span style="color: #709870;">(</span><span style="color: #0000FF;">push</span> <span style="color: #907373;">(</span>cons current-index current-path<span style="color: #907373;">)</span>
                                quote-only<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
                      <span style="color: #909183;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #709870;">(</span>1+ current-index<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #909183;">(</span>1+ current-index<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
<span id="coderef-a sublist" class="coderef-off">           <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #0000FF;">and</span> <span style="color: #887070;">(</span>&lt; current-index current-list-length<span style="color: #887070;">)</span>             <span style="color: #8D8D84;">;;</span> (a sublist)</span>
                 <span style="color: #887070;">(</span>consp <span style="color: #707183;">(</span>nth current-index current-list<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">and</span> <span style="color: #7388D6;">(</span>= <span style="color: #D0372D;">0</span> current-index<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>not cond-predicate-action-p<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                  <span style="color: #707183;">(</span><span style="color: #0000FF;">push</span> <span style="color: #7388D6;">(</span>list <span style="color: #909183;">(</span>cons current-index current-path<span style="color: #909183;">)</span>
                              nil<span style="color: #7388D6;">)</span>
                        possibly-apply-function<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">push</span> <span style="color: #707183;">(</span>list locally-scoped-symbols
                          <span style="color: #7388D6;">(</span>cons current-index current-path<span style="color: #7388D6;">)</span>
                          inner-lists-in-cond-form<span style="color: #707183;">)</span>
                    inner-lists<span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #707183;">(</span>+ current-index <span style="color: #D0372D;">1</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
           <span style="color: #858580;">(</span>t nil<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
<span id="coderef-returns" class="coderef-off">        <span style="color: #907373;">(</span>list namespace-only quote-only possibly-apply-function<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;;</span> (returns)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org52f0e1d" class="outline-3">
<h3 id="org52f0e1d"><span class="section-number-3">4.2</span> Function Application</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Since KLambda supports partial application and Elisp does not function application is
tricky.
</p>

<p>
First we enumerate forms that may never be partially applied:
</p>
<div class="org-src-container">
<pre class="src src-elisp" id="org7440913"><span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/*primitive-macros*
      '<span style="color: #7388D6;">(</span>shen/if
        shen/and
        shen/or
        shen/cond
        shen/lambda
        shen/let
        defun
        shen/freeze
        shen/trap-error<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
The general strategy to rewriting KLambda function application to Elisp is to
first blindly apply the function as though all of its arguments are present and
only deal with errors if they occur.
</p>

<p>
In the case of a <a href="#coderef-higher-order function"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-higher-order function');" onmouseout="CodeHighlightOff(this, 'coderef-higher-order function');">higher-order function</a> if normal application fails because the
function cannot be found try again with the <code>shen/</code> prefix. If the function has
known <code>arity</code>, build  <a href="#coderef-curried lambda"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curried lambda');" onmouseout="CodeHighlightOff(this, 'coderef-curried lambda');">curried</a> version and apply <a href="#coderef-incremental application"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-incremental application');" onmouseout="CodeHighlightOff(this, 'coderef-incremental application');">incrementally</a> and barring that just
feed the function arguments one-by-one and hope for the best.
</p>

<p>
If it is <a href="#coderef-a list"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-a list');" onmouseout="CodeHighlightOff(this, 'coderef-a list');">a list</a> (which presumably evaluates to a function) since there is no
hope of knowing the arity only the incremental fallback is tried.
</p>

<p>
If the function has a <a href="#coderef-known arity"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-known arity');" onmouseout="CodeHighlightOff(this, 'coderef-known arity');">known arity</a> but is undersupplied with arguments a <a href="#coderef-curried lambda"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curried lambda');" onmouseout="CodeHighlightOff(this, 'coderef-curried lambda');">curried</a>
lambda expression <b>and</b> the subsequent <code>funcalls</code> are constructed. No
fallback is required this time.
</p>

<p>
In the interests of efficiency when constructing the <a href="#coderef-curried lambda"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curried lambda');" onmouseout="CodeHighlightOff(this, 'coderef-curried lambda');">lambda expression</a> as many
arguments as possible are applied in one fell swoop to cut down on the overhead
of incremental application. For example if a function <code>f</code> takes 3 arguments but
only 2 are supplied, the constructed expresssion looks like:
</p>
<pre class="example">
(lambda (A0 A1) (lambda (A2) (apply f (list A0 A1 A2))))
</pre>
<p>
instead of:
</p>
<pre class="example">
(lambda (A0) (lambda (A1) (lambda (A2) (apply f (list A0 A1 A2)))))
</pre>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/apply-function</span> <span style="color: #7388D6;">(</span>f args locally-scoped<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">cond</span>
<span id="coderef-higher-order function" class="coderef-off">   <span style="color: #909183;">(</span>locally-scoped       <span style="color: #8D8D84;">;;</span> (higher-order function)</span>
    `<span style="color: #709870;">(</span>shen/internal/apply-higher-order-function ,f <span style="color: #907373;">(</span>list ,@args<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
<span id="coderef-a list" class="coderef-off">   <span style="color: #909183;">(</span><span style="color: #709870;">(</span>consp f<span style="color: #709870;">)</span>            <span style="color: #8D8D84;">;;</span> (a list)</span>
    `<span style="color: #709870;">(</span>shen/internal/apply-function-expression ,f <span style="color: #907373;">(</span>list ,@args<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span>t
    <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>fboundp 'shen/arity<span style="color: #907373;">)</span>
<span id="coderef-known arity" class="coderef-off">        <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>arity <span style="color: #80A880;">(</span>shen/internal/check-partial-application f <span style="color: #887070;">(</span>length args<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> <span style="color: #8D8D84;">;;</span> (known arity)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>= arity <span style="color: #D0372D;">-1</span><span style="color: #858580;">)</span>
              `<span style="color: #858580;">(</span>,f ,@args<span style="color: #858580;">)</span>
            `<span style="color: #858580;">(</span>shen/internal/apply-partially <span style="color: #80A880;">(</span><span style="color: #0000FF;">function</span> ,f<span style="color: #80A880;">)</span> <span style="color: #80A880;">(</span>list ,@args<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
      `<span style="color: #907373;">(</span>,f ,@args<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/apply-higher-order-function</span> <span style="color: #7388D6;">(</span>f args<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">condition-case</span> apply-ex <span style="color: #909183;">(</span>apply f args<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>'void-function
     <span style="color: #709870;">(</span>shen/internal/apply-higher-order-function <span style="color: #907373;">(</span>shen/internal/prefix-symbol f<span style="color: #907373;">)</span> args<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>'wrong-number-of-arguments
     <span style="color: #709870;">(</span><span style="color: #0000FF;">condition-case</span> ex
         <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>arity <span style="color: #80A880;">(</span>shen/internal/check-partial-application f <span style="color: #887070;">(</span>length args<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
           <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>= arity <span style="color: #D0372D;">-1</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span><span style="color: #ff0000; font-weight: bold;">signal</span> <span style="color: #80A880;">(</span>car apply-ex<span style="color: #80A880;">)</span> <span style="color: #80A880;">(</span>cdr apply-ex<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
             <span style="color: #858580;">(</span>apply <span style="color: #80A880;">(</span>eval <span style="color: #887070;">(</span>shen/internal/make-lambda-expression f arity <span style="color: #707183;">(</span>length args<span style="color: #707183;">)</span><span style="color: #887070;">)</span> 't<span style="color: #80A880;">)</span> args<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span>'wrong-number-of-arguments
        <span style="color: #6276BA;">(</span>shen/internal/apply-incrementally f args<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/apply-function-expression</span> <span style="color: #7388D6;">(</span>exp args<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">condition-case</span> ex <span style="color: #909183;">(</span>apply exp args<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>'wrong-number-of-arguments <span style="color: #709870;">(</span>shen/internal/apply-incrementally exp args<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/apply-partially</span> <span style="color: #7388D6;">(</span>f args<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>arity <span style="color: #907373;">(</span>shen/internal/check-partial-application f <span style="color: #6276BA;">(</span>length args<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>= arity <span style="color: #D0372D;">-1</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>apply f args<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>apply <span style="color: #907373;">(</span>eval <span style="color: #6276BA;">(</span>shen/internal/make-lambda-expression f arity <span style="color: #858580;">(</span>length args<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> 't<span style="color: #907373;">)</span> args<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span id="coderef-curried lambda" class="coderef-off"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/make-lambda-expression</span> <span style="color: #7388D6;">(</span>f arity num-args<span style="color: #7388D6;">)</span> <span style="color: #8D8D84;">;;</span> (curried lambda)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>all-args <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>single-apply-args<span style="color: #858580;">)</span>
                         <span style="color: #858580;">(</span>blast-apply-args<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                     <span style="color: #6276BA;">(</span><span style="color: #0000FF;">dotimes</span> <span style="color: #858580;">(</span>i arity <span style="color: #80A880;">(</span>list <span style="color: #887070;">(</span>reverse blast-apply-args<span style="color: #887070;">)</span>
                                             <span style="color: #887070;">(</span>reverse single-apply-args<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                       <span style="color: #858580;">(</span><span style="color: #0000FF;">push</span> <span style="color: #80A880;">(</span>intern <span style="color: #887070;">(</span>concat <span style="color: #008000;">"A"</span> <span style="color: #707183;">(</span>number-to-string i<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                             <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> <span style="color: #887070;">(</span><span style="color: #0000FF;">and</span> num-args <span style="color: #707183;">(</span>&lt; i num-args<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                                 blast-apply-args
                               single-apply-args<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>blast-apply-args <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">0</span> all-args<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>single-apply-args <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">1</span> all-args<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>expression `<span style="color: #907373;">(</span>apply <span style="color: #6276BA;">(</span><span style="color: #0000FF;">function</span> ,f<span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span>list ,@<span style="color: #858580;">(</span>append blast-apply-args single-apply-args<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #709870;">(</span>arg <span style="color: #907373;">(</span>reverse single-apply-args<span style="color: #907373;">)</span> expression<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">setq</span> expression `<span style="color: #907373;">(</span><span style="color: #0000FF;">shen/lambda</span> ,arg ,expression<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> blast-apply-args
        `<span style="color: #709870;">(</span><span style="color: #0000FF;">lambda</span> ,<span style="color: #907373;">(</span>reverse blast-apply-args<span style="color: #907373;">)</span> ,expression<span style="color: #709870;">)</span>
      expression<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span id="coderef-incremental application" class="coderef-off"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/apply-incrementally</span> <span style="color: #7388D6;">(</span>f args<span style="color: #7388D6;">)</span> <span style="color: #8D8D84;">;;</span> (incremental application)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>result f<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>current-args args<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">while</span> current-args
      <span style="color: #709870;">(</span><span style="color: #0000FF;">setq</span> result <span style="color: #907373;">(</span>funcall result <span style="color: #6276BA;">(</span>car current-args<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">setq</span> current-args <span style="color: #907373;">(</span>cdr current-args<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    result<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/check-partial-application</span> <span style="color: #7388D6;">(</span>f num-args<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>arity <span style="color: #907373;">(</span><span style="color: #0000FF;">condition-case</span> ex <span style="color: #6276BA;">(</span>shen/arity <span style="color: #858580;">(</span>shen/internal/unprefix-symbol f<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span>'error <span style="color: #D0372D;">-1</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cond</span>
     <span style="color: #709870;">(</span><span style="color: #907373;">(</span>eq <span style="color: #D0372D;">-1</span> arity<span style="color: #907373;">)</span> <span style="color: #D0372D;">-1</span><span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #907373;">(</span>= arity num-args<span style="color: #907373;">)</span> <span style="color: #D0372D;">-1</span><span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #907373;">(</span>&gt; num-args arity<span style="color: #907373;">)</span> <span style="color: #D0372D;">-1</span><span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>t arity<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org7050be6" class="outline-3">
<h3 id="org7050be6"><span class="section-number-3">4.3</span> Finding Tail Calls</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Finding tail calls in a form is complex because:
</p>
<ul class="org-ul">
<li><p>
Not all self references in the tail position of a form
are tail calls, for instance:
</p>
<pre class="example">
(defun f (a) (map (lambda X (f "blah")) a))
</pre></li>
<li><p>
<code>if</code> and <code>cond</code> forms may contain multiple tail calls:
</p>
<pre class="example">
(defun f (a b) (if true (f a) (f b))
(defun f (a b c) (cond (a (f a)) (b (f b)) (c (f c))))
</pre></li>
</ul>
</div>
<ol class="org-ol"><li><a id="orgde3c2e3"></a>Detecting Recursive Calls<br  /><div class="outline-text-5" id="text-4-3-0-1">
<p>
The function follows the same basic template as searching for <a href="#orgb29fa7a">the first
occurrence</a> of something in the AST but instead of stopping at the first
encounter keeps a <a href="#coderef-tail-calls-found"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-tail-calls-found');" onmouseout="CodeHighlightOff(this, 'coderef-tail-calls-found');">tally</a> of paths to all tail calls.
</p>

<p>
In the case where a <code>cond</code> is encountered all the predicate action pairs where
the action <a href="#coderef-cond-filter"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-cond-filter');" onmouseout="CodeHighlightOff(this, 'coderef-cond-filter');">can't be a function call</a> are filtered out and the index of each
action is added to the list of forms that <a href="#coderef-lists-left-to-search"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-lists-left-to-search');" onmouseout="CodeHighlightOff(this, 'coderef-lists-left-to-search');">might contain a tail call</a>.
</p>

<p>
In an <code>if</code> since the 2nd element is the predicate only the 3rd and possibly the
4th elements (if it exists) of the list are checked. In <code>trap-error</code> both the
action and the fallback may contain a tail call. In a <code>lambda</code>, <code>let</code> and
<code>defun</code> forms only the bodies may contain a tail call. In all other cases jump
to the end of the list and continue searching.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/find-recursive-call-paths</span> <span style="color: #7388D6;">(</span>function-name args ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span>consp ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      'shen/not-found
<span id="coderef-lists-left-to-search" class="coderef-off">    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>lists-left-to-search `<span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #80A880;">()</span> ,ast<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> <span style="color: #8D8D84;">;;</span> (lists-left-to-search)</span>
<span id="coderef-tail-calls-found" class="coderef-off">          <span style="color: #907373;">(</span>found 'shen/not-found<span style="color: #907373;">)</span><span style="color: #709870;">)</span>  <span style="color: #8D8D84;">;;</span> (tail-calls-found)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">while</span> lists-left-to-search
        <span style="color: #907373;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>search-candidate <span style="color: #80A880;">(</span>car lists-left-to-search<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>search-candidate-path <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">0</span> search-candidate<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>current-list <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">1</span> search-candidate<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>current-list-length <span style="color: #80A880;">(</span>length current-list<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>current-head <span style="color: #80A880;">(</span>car current-list<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
<span id="coderef-push-if-list" class="coderef-off">               <span style="color: #858580;">(</span>push-if-list     <span style="color: #8D8D84;">;;</span> (push-if-list)</span>
                <span style="color: #80A880;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #887070;">(</span>indexes<span style="color: #887070;">)</span>
                  <span style="color: #887070;">(</span>mapc
                   <span style="color: #707183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #7388D6;">(</span>index<span style="color: #7388D6;">)</span>
                     <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>consp <span style="color: #709870;">(</span>nth index current-list<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
                         <span style="color: #909183;">(</span><span style="color: #0000FF;">setq</span> lists-left-to-search
                               <span style="color: #709870;">(</span>append lists-left-to-search
                                       <span style="color: #907373;">(</span>list
                                        <span style="color: #6276BA;">(</span>list <span style="color: #858580;">(</span>cons index search-candidate-path<span style="color: #858580;">)</span>
                                              <span style="color: #858580;">(</span>nth index current-list<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                   indexes<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> lists-left-to-search <span style="color: #80A880;">(</span>cdr lists-left-to-search<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span><span style="color: #0000FF;">and</span> <span style="color: #707183;">(</span>eq current-head function-name<span style="color: #707183;">)</span>
                        <span style="color: #707183;">(</span>= <span style="color: #7388D6;">(</span>length <span style="color: #909183;">(</span>cdr current-list<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>length args<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                   <span style="color: #887070;">(</span><span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span>not <span style="color: #7388D6;">(</span>consp found<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                       <span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> found <span style="color: #7388D6;">(</span>list search-candidate-path<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                     <span style="color: #707183;">(</span><span style="color: #0000FF;">push</span> search-candidate-path found<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>eq current-head 'shen/cond<span style="color: #887070;">)</span>
                   <span style="color: #887070;">(</span><span style="color: #0000FF;">progn</span>
                     <span style="color: #707183;">(</span>mapc
                      <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>action-index-pair<span style="color: #909183;">)</span>
                        <span style="color: #909183;">(</span><span style="color: #0000FF;">setq</span> lists-left-to-search
                              <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>path-to-action
                                     <span style="color: #858580;">(</span>append <span style="color: #80A880;">(</span>list <span style="color: #D0372D;">1</span> <span style="color: #887070;">(</span>1+ <span style="color: #707183;">(</span>nth <span style="color: #D0372D;">1</span> action-index-pair<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                                             search-candidate-path<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                                <span style="color: #907373;">(</span>append lists-left-to-search
                                        <span style="color: #6276BA;">(</span>list
                                         <span style="color: #858580;">(</span>list path-to-action
                                               <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">0</span> action-index-pair<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                      <span style="color: #7388D6;">(</span>mapcar
                       <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>predicate-action-index<span style="color: #709870;">)</span>
                         <span style="color: #709870;">(</span>list <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">1</span> <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">0</span> predicate-action-index<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                               <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">1</span> predicate-action-index<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
<span id="coderef-cond-filter" class="coderef-off">                       <span style="color: #909183;">(</span>shen/internal/filter  <span style="color: #8D8D84;">;;</span> (cond-filter)</span>
                        <span style="color: #709870;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #907373;">(</span>predicate-action-pair<span style="color: #907373;">)</span>
                          <span style="color: #907373;">(</span>consp <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> predicate-action-pair<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                        <span style="color: #709870;">(</span>cdr current-list<span style="color: #709870;">)</span>
                        't<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>eq current-head 'shen/if<span style="color: #887070;">)</span>
                   <span style="color: #887070;">(</span><span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span>= <span style="color: #D0372D;">4</span> current-list-length<span style="color: #707183;">)</span>
                       <span style="color: #707183;">(</span>funcall push-if-list '<span style="color: #7388D6;">(</span><span style="color: #D0372D;">2</span> <span style="color: #D0372D;">3</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                     <span style="color: #707183;">(</span>funcall push-if-list '<span style="color: #7388D6;">(</span><span style="color: #D0372D;">2</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>eq current-head 'shen/trap-error<span style="color: #887070;">)</span>
                   <span style="color: #887070;">(</span>funcall push-if-list '<span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> <span style="color: #D0372D;">2</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span><span style="color: #887070;">(</span><span style="color: #0000FF;">or</span> <span style="color: #707183;">(</span>eq current-head 'shen/let<span style="color: #707183;">)</span>
                       <span style="color: #707183;">(</span>eq current-head 'defun<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                   <span style="color: #887070;">(</span>funcall push-if-list '<span style="color: #707183;">(</span><span style="color: #D0372D;">3</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>eq current-head 'shen/lambda<span style="color: #887070;">)</span>
                   <span style="color: #887070;">(</span>funcall push-if-list '<span style="color: #707183;">(</span><span style="color: #D0372D;">2</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span>t <span style="color: #887070;">(</span>funcall push-if-list <span style="color: #707183;">(</span>list <span style="color: #7388D6;">(</span>- current-list-length <span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      found<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div></li>
<li><a id="orgf56b295"></a>Detecting Function Application Context<br  /><div class="outline-text-5" id="text-4-3-0-2">
<p>
This function captures the surrounding function application context around
a tail call. For instance in the function:
</p>
<pre class="example">
(defun factorial (x) (if (= 0 x) 0 (+ 1 (factorial (- x 1)))))
</pre>
<p>
<code>(+ 1 ...)</code> is the context.
</p>

<p>
Given a path to a tail call <code>tail-call-path</code> it works its way from the top of
the form to that location. Since Elisp does not support lexical binding as
locally scoped variables (function arguments, let assignments) are also captured
as they are encountered in the path. When it encounters a function application
it starts "recording" that context into <a href="#coderef-start-accumulator"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-start-accumulator');" onmouseout="CodeHighlightOff(this, 'coderef-start-accumulator');">an accumulator</a>.
</p>

<p>
Some forms stop the recording because they should not be captured. In the case
of <a href="#coderef-if-stop-recording"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-if-stop-recording');" onmouseout="CodeHighlightOff(this, 'coderef-if-stop-recording');">if's</a> just stop recording and move on, with <a href="#coderef-let-or-lambda-stop-recording"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-let-or-lambda-stop-recording');" onmouseout="CodeHighlightOff(this, 'coderef-let-or-lambda-stop-recording');">let's or lambda's</a> and <a href="#coderef-defun-stop-recording"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-defun-stop-recording');" onmouseout="CodeHighlightOff(this, 'coderef-defun-stop-recording');">defun's</a> skip
but also capture the assignments or arguments. In the case of <a href="#coderef-cond-stop-recording"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-cond-stop-recording');" onmouseout="CodeHighlightOff(this, 'coderef-cond-stop-recording');">cond's</a> skip twice
to move into the list containing the predicate action pair. If it is a <a href="#coderef-do-stop-recording"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-do-stop-recording');" onmouseout="CodeHighlightOff(this, 'coderef-do-stop-recording');">do</a> just
skip it.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/start-of-function-chain</span> <span style="color: #7388D6;">(</span>tail-call-path ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>from-the-top <span style="color: #907373;">(</span>reverse tail-call-path<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>current-from-top-path<span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>path-left-to-tail-call <span style="color: #907373;">(</span>reverse tail-call-path<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
<span id="coderef-start-accumulator" class="coderef-off">         <span style="color: #709870;">(</span>start tail-call-path<span style="color: #709870;">)</span> <span style="color: #8D8D84;">;;</span> (start-accumulator)</span>
         <span style="color: #709870;">(</span>locally-scoped<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cl-flet</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>append-and-advance
               <span style="color: #6276BA;">(</span>X <span style="color: #6434A3;">&amp;optional</span> reset-start<span style="color: #6276BA;">)</span>
               <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
                 <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> start
<span id="coderef-reset-start" class="coderef-off">                       <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> reset-start <span style="color: #8D8D84;">;;</span> (reset-start)</span>
                           tail-call-path
                         current-from-top-path<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> current-from-top-path
                       <span style="color: #80A880;">(</span>append <span style="color: #887070;">(</span>reverse <span style="color: #707183;">(</span>shen/internal/path-slice path-left-to-tail-call <span style="color: #D0372D;">0</span> X<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                               current-from-top-path<span style="color: #80A880;">)</span>
                       path-left-to-tail-call <span style="color: #80A880;">(</span>shen/internal/path-slice path-left-to-tail-call X<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>

                 <span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">while</span> <span style="color: #907373;">(</span>not <span style="color: #6276BA;">(</span>equal current-from-top-path tail-call-path<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>current-list <span style="color: #80A880;">(</span>shen/internal/get-element-at current-from-top-path ast<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>current-head <span style="color: #80A880;">(</span>car current-list<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">cond</span>
           <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #0000FF;">or</span> <span style="color: #887070;">(</span>not <span style="color: #707183;">(</span>shen/symbol-p current-head<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
<span id="coderef-if-stop-recording" class="coderef-off">                <span style="color: #887070;">(</span>eq 'shen/if current-head<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>  <span style="color: #8D8D84;">;;</span> (if-stop-recording)</span>
            <span style="color: #80A880;">(</span>append-and-advance <span style="color: #D0372D;">1</span> 't<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
<span id="coderef-defun-stop-recording" class="coderef-off">           <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>eq 'defun current-head<span style="color: #80A880;">)</span>    <span style="color: #8D8D84;">;;</span> (defun-stop-recording)</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> locally-scoped <span style="color: #707183;">(</span>append <span style="color: #7388D6;">(</span>nth <span style="color: #D0372D;">2</span> current-list<span style="color: #7388D6;">)</span> locally-scoped<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span>append-and-advance <span style="color: #D0372D;">1</span> 't<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
           <span style="color: #858580;">(</span><span style="color: #80A880;">(</span><span style="color: #0000FF;">or</span>
             <span style="color: #887070;">(</span>eq 'shen/let current-head<span style="color: #887070;">)</span>
<span id="coderef-let-or-lambda-stop-recording" class="coderef-off">             <span style="color: #887070;">(</span>eq 'shen/lambda current-head<span style="color: #887070;">)</span><span style="color: #80A880;">)</span> <span style="color: #8D8D84;">;;;</span> (let-or-lambda-stop-recording)</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> locally-scoped <span style="color: #707183;">(</span>append <span style="color: #7388D6;">(</span>list <span style="color: #909183;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> locally-scoped<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span>append-and-advance <span style="color: #D0372D;">1</span> 't<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
<span id="coderef-cond-stop-recording" class="coderef-off">           <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>eq 'shen/cond current-head<span style="color: #80A880;">)</span>     <span style="color: #8D8D84;">;;;</span> (cond-stop-recording)</span>
            <span style="color: #80A880;">(</span>append-and-advance <span style="color: #D0372D;">2</span> 't<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
<span id="coderef-do-stop-recording" class="coderef-off">           <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>eq 'shen/do current-head<span style="color: #80A880;">)</span>       <span style="color: #8D8D84;">;;;</span> (do-stop-recording)</span>
            <span style="color: #80A880;">(</span>append-and-advance <span style="color: #D0372D;">1</span> 't<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
           <span style="color: #858580;">(</span>t <span style="color: #80A880;">(</span>append-and-advance <span style="color: #D0372D;">1</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      start<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div></li>
<li><a id="orgb92aed6"></a>Getting the Tail Calls<br  /><div class="outline-text-5" id="text-4-3-0-3">
<p>
Now that we can get a list of recursive calls and their surrounding context
a proper tail call is simply one without any context, i.e it is the last thing
left to do.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/get-tail-call-paths</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>function-name <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">1</span> ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>args <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">2</span> ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>body <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">3</span> ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>recursive-call-paths <span style="color: #907373;">(</span>shen/internal/find-recursive-call-paths function-name args body<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>eq recursive-call-paths 'shen/not-found<span style="color: #709870;">)</span>
        'shen/not-found
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>accum<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #6276BA;">(</span>tail-call-path recursive-call-paths <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> accum <span style="color: #80A880;">(</span>reverse accum<span style="color: #80A880;">)</span> 'shen/not-found<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>context <span style="color: #887070;">(</span>shen/start-of-function-chain tail-call-path body<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> <span style="color: #80A880;">(</span>equal context tail-call-path<span style="color: #80A880;">)</span>
                <span style="color: #80A880;">(</span><span style="color: #0000FF;">push</span> <span style="color: #887070;">(</span>append tail-call-path <span style="color: #707183;">(</span>list <span style="color: #D0372D;">3</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span> accum<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div></li></ol>
</div>
<div id="outline-container-org202a339" class="outline-3">
<h3 id="org202a339"><span class="section-number-3">4.4</span> Generating A TCO'ed Function</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Finally we can optimize tail calls into trampolines. The body of the trampoline
matches the body of unoptimized function except that tail calls are replaced by
vector that holds the arguments to the recursive call fully evaluated:
</p>

<p>
An Elisp vector is chosen because KLambda code can never return one and so
uniquely identifies an intermediate return value from a recursive function.
KLambda vectors are represented by <a href="#org79fade9">hash-tables</a>
</p>

<p>
A while loop extracts the arguments from the struct and passes them back into
the trampoline until it returns something other than the struct. This is the return
value.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/trampoline-body</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>args <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">2</span> ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>body <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">3</span> ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>tail-trampoline <span style="color: #907373;">(</span>make-symbol <span style="color: #008000;">"tail-trampoline"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    `<span style="color: #909183;">(</span><span style="color: #0000FF;">cl-flet</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>,tail-trampoline ,args ,body<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
       <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>result <span style="color: #858580;">(</span>funcall <span style="color: #80A880;">(</span><span style="color: #0000FF;">function</span> ,tail-trampoline<span style="color: #80A880;">)</span> ,@args<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
         <span style="color: #907373;">(</span><span style="color: #0000FF;">while</span> <span style="color: #6276BA;">(</span>vectorp result<span style="color: #6276BA;">)</span>
           <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> result <span style="color: #858580;">(</span>apply <span style="color: #80A880;">(</span><span style="color: #0000FF;">function</span> ,tail-trampoline<span style="color: #80A880;">)</span> <span style="color: #80A880;">(</span>aref result <span style="color: #D0372D;">0</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
         result<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
This overall approach owes a lot to Wilfred Hughes' excellent <a href="https://github.com/Wilfred/tco.el">tco.el</a>. The
essential difference is that he returns a function instead of a vector. Since
vectors will never appear in the generated Elisp (KLambda vectors are
hash-tables underneath), latter approach uniquely identifies a trampolined value
and guards against the possibility that if the final return value is a function
there would be no way to tell when recursion terminated.
</p>
</div>
</div>

<div id="outline-container-org521dfcf" class="outline-3">
<h3 id="org521dfcf"><span class="section-number-3">4.5</span> Modifying The AST</h3>
<div class="outline-text-3" id="text-4-5">
<p>
Now that we have mechanisms for
</p>
<ul class="org-ul">
<li><a href="#org8ffa5f1">identifying</a> the parts of the AST that need changing</li>
<li><a href="#org52f0e1d">applying functions calls</a> in the face of partial application and</li>
<li><a href="#org7050be6">optimizing</a> tail calls</li>
</ul>
<p>
we are ready to transform incoming KLambda code into Elisp.
</p>

<p>
The overall flow goes like this:
</p>
<ol class="org-ol">
<li><a href="#coderef-paths"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-paths');" onmouseout="CodeHighlightOff(this, 'coderef-paths');">walk the KLambda code</a> and get a list of locations that need to be transformed</li>
<li><a href="#coderef-quote and namespace"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-quote and namespace');" onmouseout="CodeHighlightOff(this, 'coderef-quote and namespace');">quote and namespace</a> as required but hold off on function application</li>
<li>Sift through the function application locations and remove ones that point to
special forms since they cannot be curried.</li>
<li>If the KLambda is a <a href="#coderef-defun form"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-defun form');" onmouseout="CodeHighlightOff(this, 'coderef-defun form');">defun form</a>
<ol class="org-ol">
<li>Isolate function application that occurs <a href="#coderef-inside the recursive call"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-inside the recursive call');" onmouseout="CodeHighlightOff(this, 'coderef-inside the recursive call');">inside the recursive call</a>, curry
accordingly and <a href="#coderef-package up the arguments"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-package up the arguments');" onmouseout="CodeHighlightOff(this, 'coderef-package up the arguments');">package up the arguments</a> into tue struct that marks a
tail call return.</li>
<li><a href="#coderef-Sub in the recurs marker"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-Sub in the recurs marker');" onmouseout="CodeHighlightOff(this, 'coderef-Sub in the recurs marker');">Sub in the recurs marker</a> throughout the body of the form.</li>
<li>Sub in the <a href="#coderef-rest of the function applications"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rest of the function applications');" onmouseout="CodeHighlightOff(this, 'coderef-rest of the function applications');">rest of the function applications</a></li>
<li>Add the trampolines and <a href="#coderef-write out the defun"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-write out the defun');" onmouseout="CodeHighlightOff(this, 'coderef-write out the defun');">write out the defun</a>.</li>
</ol></li>
<li>Otherwise just sub in function applications across the form without regard for tail calls.</li>
</ol>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/parse-ast</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span>consp ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>shen/symbol-p ast<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>list 'quote ast<span style="color: #709870;">)</span> ast<span style="color: #909183;">)</span>
<span id="coderef-paths" class="coderef-off">    <span style="color: #909183;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>function-and-symbol-paths <span style="color: #6276BA;">(</span>shen/internal/get-function-symbol-and-funcall-paths ast<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> <span style="color: #8D8D84;">;;;</span> (paths)</span>
           <span style="color: #907373;">(</span>namespace-only <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">0</span> function-and-symbol-paths<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>quote-only <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> function-and-symbol-paths<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>possibly-apply-function <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">2</span> function-and-symbol-paths<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>current-ast ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
<span id="coderef-quote and namespace" class="coderef-off">        <span style="color: #907373;">(</span>shen/internal/namespace-and-quote current-ast namespace-only quote-only<span style="color: #907373;">)</span> <span style="color: #8D8D84;">;;;</span> (quote and namespace)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>apply-function <span style="color: #80A880;">(</span>shen/internal/filter
                               <span style="color: #887070;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #707183;">(</span>path-local<span style="color: #707183;">)</span>
                                 <span style="color: #707183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>token <span style="color: #709870;">(</span>shen/internal/get-element-at <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">0</span> path-local<span style="color: #907373;">)</span> ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                                   <span style="color: #7388D6;">(</span>not <span style="color: #909183;">(</span>memq token shen/*primitive-macros*<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                               possibly-apply-function<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
<span id="coderef-defun form" class="coderef-off">          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>eq <span style="color: #80A880;">(</span>car current-ast<span style="color: #80A880;">)</span> 'defun<span style="color: #858580;">)</span> <span style="color: #8D8D84;">;;;</span> (defun form)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>tail-call-paths <span style="color: #707183;">(</span>shen/internal/get-tail-call-paths ast<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> <span style="color: #887070;">(</span>not <span style="color: #707183;">(</span>eq tail-call-paths 'shen/not-found<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                    <span style="color: #887070;">(</span><span style="color: #0000FF;">let</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>not-in-tail-call apply-function<span style="color: #7388D6;">)</span>
                          <span style="color: #7388D6;">(</span>in-tail-call<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                      <span style="color: #707183;">(</span><span style="color: #0000FF;">progn</span>
                        <span style="color: #7388D6;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #909183;">(</span>path tail-call-paths nil<span style="color: #909183;">)</span>
<span id="coderef-inside the recursive call" class="coderef-off">                          <span style="color: #909183;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>tco-non-tco-pair <span style="color: #8D8D84;">;;;</span> (inside the recursive call)</span>
                                  <span style="color: #6276BA;">(</span>shen/internal/partition
                                   <span style="color: #858580;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #80A880;">(</span>apply-function-path-local<span style="color: #80A880;">)</span>
                                     <span style="color: #80A880;">(</span>shen/internal/starts-with-path path <span style="color: #887070;">(</span>nth <span style="color: #D0372D;">0</span> apply-function-path-local<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                                   not-in-tail-call<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                                 <span style="color: #907373;">(</span>funcalled-tco
                                  <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>normalized-paths
                                          <span style="color: #887070;">(</span>shen/internal/filter
                                           <span style="color: #707183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #7388D6;">(</span>path-local<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>not <span style="color: #909183;">(</span>equal <span style="color: #709870;">(</span>nth <span style="color: #D0372D;">0</span> path-local<span style="color: #709870;">)</span> '<span style="color: #709870;">(</span><span style="color: #D0372D;">0</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                                           <span style="color: #707183;">(</span>mapcar
                                            <span style="color: #7388D6;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #909183;">(</span>in-tco-path-local<span style="color: #909183;">)</span>
                                              <span style="color: #909183;">(</span>list
                                               <span style="color: #709870;">(</span>shen/internal/get-path-relative-to path <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">0</span> in-tco-path-local<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                                               <span style="color: #709870;">(</span>nth <span style="color: #D0372D;">1</span> in-tco-path-local<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
                                            <span style="color: #7388D6;">(</span>nth <span style="color: #D0372D;">0</span> tco-non-tco-pair<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                                         <span style="color: #80A880;">(</span>tail-call <span style="color: #887070;">(</span>shen/internal/get-element-at path current-ast<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                                    <span style="color: #858580;">(</span>list
                                     path
<span id="coderef-package up the arguments" class="coderef-off">                                     `<span style="color: #80A880;">(</span>vector <span style="color: #887070;">(</span>list ,@<span style="color: #707183;">(</span>cdr <span style="color: #7388D6;">(</span>shen/internal/add-funcalls tail-call normalized-paths<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #8D8D84;">;;;</span> (package up the arguments)</span>
                            <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
                              <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> not-in-tail-call <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> tco-non-tco-pair<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                              <span style="color: #907373;">(</span><span style="color: #0000FF;">push</span> funcalled-tco in-tail-call<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
<span id="coderef-Sub in the recurs marker" class="coderef-off">                        <span style="color: #7388D6;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #909183;">(</span>path-tail-call in-tail-call nil<span style="color: #909183;">)</span>  <span style="color: #8D8D84;">;;;</span> (Sub in the recurs marker)</span>
                          <span style="color: #909183;">(</span>shen/internal/modify-ast current-ast <span style="color: #709870;">(</span>list <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">0</span> path-tail-call<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                                                    <span style="color: #709870;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #907373;">(</span>path current-ast<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">1</span> path-tail-call<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
<span id="coderef-rest of the function applications" class="coderef-off">                        <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> current-ast <span style="color: #909183;">(</span>shen/internal/add-funcalls current-ast not-in-tail-call<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #8D8D84;">;;;</span> (rest of the function applications)</span>
<span id="coderef-write out the defun" class="coderef-off">                        <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> current-ast `<span style="color: #909183;">(</span><span style="color: #0000FF;">defun</span> ,<span style="color: #709870;">(</span>nth <span style="color: #D0372D;">1</span> current-ast<span style="color: #709870;">)</span> ,<span style="color: #709870;">(</span>nth <span style="color: #D0372D;">2</span> current-ast<span style="color: #709870;">)</span> ,<span style="color: #709870;">(</span>shen/trampoline-body current-ast<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span> <span style="color: #8D8D84;">;;;</span> (write out the defun)</span>
                  <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> current-ast <span style="color: #707183;">(</span>shen/internal/add-funcalls current-ast apply-function<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                current-ast<span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">progn</span>
              <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> current-ast <span style="color: #887070;">(</span>shen/internal/add-funcalls current-ast apply-function<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
              current-ast<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
To support the above transformation we need functions the namespace and quote the AST:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/namespace-and-quote</span> <span style="color: #7388D6;">(</span>ast namespace-only-paths quote-only-paths<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span>
    <span style="color: #909183;">(</span>shen/internal/modify-ast ast namespace-only-paths
                     <span style="color: #709870;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #907373;">(</span>path ast<span style="color: #907373;">)</span>
                       <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>element <span style="color: #80A880;">(</span>shen/internal/get-element-at path ast<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                         <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>not <span style="color: #80A880;">(</span>shen/internal/symbol-prefixed-p element<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                             <span style="color: #858580;">(</span>shen/internal/prefix-symbol <span style="color: #80A880;">(</span>shen/internal/get-element-at path ast<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                           element<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/internal/modify-ast ast quote-only-paths
                     <span style="color: #709870;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #907373;">(</span>path ast<span style="color: #907373;">)</span>
                       <span style="color: #907373;">(</span>list 'quote <span style="color: #6276BA;">(</span>shen/internal/get-element-at path ast<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    ast<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
, and run function application in the right places:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/add-funcalls</span> <span style="color: #7388D6;">(</span>ast apply-function<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>paths-only <span style="color: #907373;">(</span>mapcar <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>path-local<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">0</span> path-local<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> apply-function<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/internal/modify-ast ast <span style="color: #709870;">(</span>mapcar #'shen/internal/get-path-parent paths-only<span style="color: #709870;">)</span>
                     <span style="color: #709870;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #907373;">(</span>path ast<span style="color: #907373;">)</span>
                       <span style="color: #907373;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>current-funcalled-list <span style="color: #80A880;">(</span>shen/internal/get-element-at path ast<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                              <span style="color: #858580;">(</span>function-name <span style="color: #80A880;">(</span>car current-funcalled-list<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                              <span style="color: #858580;">(</span>function-arguments <span style="color: #80A880;">(</span>cdr current-funcalled-list<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                         <span style="color: #6276BA;">(</span>shen/internal/apply-function
                          function-name
                          function-arguments
                          <span style="color: #858580;">(</span>shen/internal/lookup-with-default <span style="color: #80A880;">(</span>cons <span style="color: #D0372D;">0</span> path<span style="color: #80A880;">)</span> apply-function nil<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5bc6dbb" class="outline-3">
<h3 id="org5bc6dbb"><span class="section-number-3">4.6</span> (Unused) Isolating and Filling</h3>
<div class="outline-text-3" id="text-4-6">
<p>
I was going to do something clever with the function application context but that didn't work
so these functions are unused for now.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/make-holed-context</span> <span style="color: #7388D6;">(</span>tail-call-path function-chain-path ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>function-chain <span style="color: #907373;">(</span>shen/internal/get-element-at function-chain-path ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>tail-call <span style="color: #907373;">(</span>shen/internal/get-element-at tail-call-path ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>tail-call-relative-path
          <span style="color: #907373;">(</span>shen/internal/path-slice tail-call-path <span style="color: #D0372D;">0</span>
                  <span style="color: #6276BA;">(</span>- <span style="color: #858580;">(</span>length tail-call-path<span style="color: #858580;">)</span>
                     <span style="color: #858580;">(</span>length function-chain-path<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/internal/nset-element-at tail-call-relative-path function-chain 'shen/__hole__<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/used-in-context</span> <span style="color: #7388D6;">(</span>context locally-scoped<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>mapcar <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>symbol-index-pair<span style="color: #709870;">)</span>
            <span style="color: #709870;">(</span>nth <span style="color: #D0372D;">1</span> symbol-index-pair<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">(</span>shen/internal/filter
           <span style="color: #709870;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #907373;">(</span>v<span style="color: #907373;">)</span>
             <span style="color: #907373;">(</span>not <span style="color: #6276BA;">(</span>eq 'shen/not-found <span style="color: #858580;">(</span>shen/internal/find-all v context<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
           locally-scoped
           't<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/substitute-in-context</span> <span style="color: #7388D6;">(</span>context locally-scoped-alist<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>current-context context<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #709870;">(</span>locally-scoped-pair locally-scoped-alist current-context<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>name <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">0</span> locally-scoped-pair<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>value <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">1</span> locally-scoped-pair<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>all-matching-paths <span style="color: #858580;">(</span>shen/internal/find-all name current-context<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> <span style="color: #6276BA;">(</span>not <span style="color: #858580;">(</span>eq all-matching-paths 'shen/not-found<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #858580;">(</span>path all-matching-paths nil<span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span>shen/internal/nset-element-at path current-context value<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8991d7e" class="outline-2">
<h2 id="org8991d7e"><span class="section-number-2">5</span> Optimizations</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-org4db61ef" class="outline-3">
<h3 id="org4db61ef"><span class="section-number-3">5.1</span> Consolidate Call Chains</h3>
<div class="outline-text-3" id="text-5-1">
<p>
KLambda code is rife with argument chains such as <code>(cons x (cons y
nil))</code> for list building and <code>(@s "x" (@s "y" ""))</code> for string concatenation
which can easily be rewritten to more efficient variadic Elisp functions.
</p>

<p>
A generic function that takes <code>matcher-fn</code> which finds these chains, a
<code>collector-fn</code> that accumulates them and <code>tx-fn</code> which rewrites:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/consolidate</span> <span style="color: #7388D6;">(</span>ast matcher-fn collector-fn tx-fn<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>current-ast ast<span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>location-containing-chain
          <span style="color: #907373;">(</span>shen/internal/list-containing-first-occurrence-of matcher-fn ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">while</span> <span style="color: #709870;">(</span>not <span style="color: #907373;">(</span>eq location-containing-chain 'shen/not-found<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>current-chain <span style="color: #858580;">(</span>shen/internal/get-element-at location-containing-chain current-ast<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>accum<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">progn</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">while</span> <span style="color: #858580;">(</span>funcall matcher-fn current-chain<span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #0000FF;">let</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>collected <span style="color: #707183;">(</span>funcall collector-fn accum current-chain<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
              <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> accum <span style="color: #887070;">(</span>nth <span style="color: #D0372D;">0</span> collected<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
              <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> current-chain <span style="color: #887070;">(</span>nth <span style="color: #D0372D;">1</span> collected<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> current-ast
                <span style="color: #858580;">(</span>shen/internal/nset-element-at
                 location-containing-chain
                 current-ast
                 <span style="color: #80A880;">(</span>funcall tx-fn accum current-chain<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> location-containing-chain
                <span style="color: #858580;">(</span>shen/internal/list-containing-first-occurrence-of matcher-fn current-ast<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    current-ast<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org29f34f3" class="outline-3">
<h3 id="org29f34f3"><span class="section-number-3">5.2</span> Consolidate Cons</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Convert <code>(cons a (cons b (blah)))</code> into <code>(append (list 'a 'b) (blah))</code>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/consolidate-cons</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>shen/internal/consolidate
   ast
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>current-list<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> current-list
          <span style="color: #907373;">(</span>consp current-list<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>eq <span style="color: #D0372D;">3</span> <span style="color: #6276BA;">(</span>length current-list<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>eq <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">0</span> current-list<span style="color: #6276BA;">)</span> 'shen/cons<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum current-chain<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>list <span style="color: #907373;">(</span>cons <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> current-chain<span style="color: #6276BA;">)</span> accum<span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">2</span> current-chain<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum remaining-chain<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>eq remaining-chain 'nil<span style="color: #907373;">)</span>
         `<span style="color: #907373;">(</span>list ,@<span style="color: #6276BA;">(</span>reverse accum<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
       `<span style="color: #907373;">(</span>append <span style="color: #6276BA;">(</span>list ,@<span style="color: #858580;">(</span>reverse accum<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> ,remaining-chain<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org7ac6d10" class="outline-3">
<h3 id="org7ac6d10"><span class="section-number-3">5.3</span> Consolidate @s</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Convert <code>(@s "a" (@s "b" (blah)))</code> into <code>(concat (concat "a" "b") (blah))</code>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/consolidate-@s</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>shen/internal/consolidate
   ast
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>current-list<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> current-list
          <span style="color: #907373;">(</span>consp current-list<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>eq <span style="color: #D0372D;">3</span> <span style="color: #6276BA;">(</span>length current-list<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>eq <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">0</span> current-list<span style="color: #6276BA;">)</span> 'shen/@s<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum current-chain<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>list <span style="color: #907373;">(</span>cons <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> current-chain<span style="color: #6276BA;">)</span> accum<span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">2</span> current-chain<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum remaining-chain<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>list 'concat <span style="color: #907373;">(</span>cons 'concat <span style="color: #6276BA;">(</span>reverse accum<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> remaining-chain<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org55b123b" class="outline-3">
<h3 id="org55b123b"><span class="section-number-3">5.4</span> Consolidate tl</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Convert <code>(tl (tl (tl Xs)))</code> to <code>(nthcdr 3 Xs)</code>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/consolidate-tl</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>shen/internal/consolidate
   ast
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>current-list<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> current-list
          <span style="color: #907373;">(</span>consp current-list<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>eq <span style="color: #D0372D;">2</span> <span style="color: #6276BA;">(</span>length current-list<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>eq <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">0</span> current-list<span style="color: #6276BA;">)</span> 'shen/tl<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum current-chain<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>list <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> <span style="color: #6276BA;">(</span>not accum<span style="color: #6276BA;">)</span> <span style="color: #D0372D;">1</span> <span style="color: #6276BA;">(</span>+ accum <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span>nth <span style="color: #D0372D;">1</span> current-chain<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum remaining-chain<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>list 'nthcdr accum remaining-chain<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org080ef92" class="outline-3">
<h3 id="org080ef92"><span class="section-number-3">5.5</span> Add 1+'s</h3>
<div class="outline-text-3" id="text-5-5">
<p>
Convert <code>(+ X 1)</code> or <code>(+ 1 X)</code> to <code>(1+ X)</code>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/add-1+</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>shen/internal/consolidate
   ast
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>current-list<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> current-list
          <span style="color: #907373;">(</span>consp current-list<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>eq <span style="color: #D0372D;">3</span> <span style="color: #6276BA;">(</span>length current-list<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">and</span> <span style="color: #6276BA;">(</span>eq <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">0</span> current-list<span style="color: #858580;">)</span> 'shen/+<span style="color: #6276BA;">)</span>
               <span style="color: #6276BA;">(</span><span style="color: #0000FF;">or</span> <span style="color: #858580;">(</span>eq <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #80A880;">)</span> <span style="color: #D0372D;">1</span><span style="color: #858580;">)</span>
                   <span style="color: #858580;">(</span>eq <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">2</span> current-list<span style="color: #80A880;">)</span> <span style="color: #D0372D;">1</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum current-list<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>eq <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #6276BA;">)</span> <span style="color: #D0372D;">1</span><span style="color: #907373;">)</span>
         <span style="color: #907373;">(</span>list <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">2</span> current-list<span style="color: #6276BA;">)</span> nil<span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span>list <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #6276BA;">)</span> nil<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum remaining-chain<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>list '1+ accum<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org749c258" class="outline-3">
<h3 id="org749c258"><span class="section-number-3">5.6</span> Nil Comparisons To Null</h3>
<div class="outline-text-3" id="text-5-6">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/nil-to-null</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>shen/internal/consolidate
   ast
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>current-list<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> current-list
          <span style="color: #907373;">(</span>consp current-list<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>eq <span style="color: #D0372D;">3</span> <span style="color: #6276BA;">(</span>length current-list<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">and</span> <span style="color: #6276BA;">(</span>eq <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">0</span> current-list<span style="color: #858580;">)</span> 'shen/=<span style="color: #6276BA;">)</span>
               <span style="color: #6276BA;">(</span><span style="color: #0000FF;">or</span> <span style="color: #858580;">(</span>eq <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #80A880;">)</span> 'nil<span style="color: #858580;">)</span>
                   <span style="color: #858580;">(</span>eq <span style="color: #80A880;">(</span>nth <span style="color: #D0372D;">2</span> current-list<span style="color: #80A880;">)</span> 'nil<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum current-list<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span><span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>eq <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #6276BA;">)</span> 'nil<span style="color: #907373;">)</span>
         <span style="color: #907373;">(</span>list <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">2</span> current-list<span style="color: #6276BA;">)</span> nil<span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span>list <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> current-list<span style="color: #6276BA;">)</span> nil<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>accum remaining-chain<span style="color: #709870;">)</span>
     `<span style="color: #709870;">(</span>shen/internal/predicate-&gt;shen <span style="color: #907373;">(</span>null ,accum<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgeed8f15" class="outline-2">
<h2 id="orgeed8f15"><span class="section-number-2">6</span> Overrides</h2>
<div class="outline-text-2" id="text-6">
<p>
There are four types of overrides, those which:
</p>
<ol class="org-ol">
<li>boost <a href="#orgb099cae">performance</a></li>
<li>are necessary because KLambda vectors are represented as <a href="#org3da0e33">hash tables</a>.</li>
<li>are necessary because Klambda functions are <a href="#org5400114">prefixed</a>.</li>
<li>fix <a href="#org84f1566">klambda bugs</a>.</li>
</ol>

<p>
They are represented as a dotted pair alists where the <code>car</code> of the list is a
function name or form which when found in Klambda code is replaces with the
<code>cdr</code> of the form.
</p>
</div>
<div id="outline-container-orgb099cae" class="outline-3">
<h3 id="orgb099cae"><span class="section-number-3">6.1</span> Performance</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/internal/*performance-overrides*
      '<span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>map . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/map</span> <span style="color: #907373;">(</span>F Xs<span style="color: #907373;">)</span>
                <span style="color: #907373;">(</span>mapcar <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>X<span style="color: #858580;">)</span>
                          <span style="color: #858580;">(</span>shen/internal/apply-higher-order-function F <span style="color: #80A880;">(</span>list X<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                        Xs<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>shen.lazyderef . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/shen\.lazyderef</span>
                             <span style="color: #907373;">(</span>X ProcessN<span style="color: #907373;">)</span>
                           <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>Current X<span style="color: #858580;">)</span>
                                 <span style="color: #858580;">(</span>KeepLooking t<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                             <span style="color: #6276BA;">(</span><span style="color: #0000FF;">while</span> KeepLooking
                               <span style="color: #858580;">(</span><span style="color: #0000FF;">shen/if</span>
                                <span style="color: #80A880;">(</span>shen/shen.pvar? Current<span style="color: #80A880;">)</span>
                                <span style="color: #80A880;">(</span><span style="color: #0000FF;">shen/let</span> Value <span style="color: #887070;">(</span>shen/shen.valvector Current ProcessN<span style="color: #887070;">)</span>
                                          <span style="color: #887070;">(</span><span style="color: #0000FF;">shen/if</span> <span style="color: #707183;">(</span>shen/= Value 'shen.-null-<span style="color: #707183;">)</span>
                                                   <span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> KeepLooking nil<span style="color: #707183;">)</span>
                                                   <span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> Current Value<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                                <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> KeepLooking nil<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                             Current<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>append . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/append</span> <span style="color: #907373;">(</span>Xs Ys<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>append Xs Ys<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>shen.string-&gt;bytes . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/shen.string-&gt;bytes</span> <span style="color: #907373;">(</span>S<span style="color: #907373;">)</span>
                               <span style="color: #907373;">(</span>string-to-list S<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>shen.sum . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/shen.sum</span> <span style="color: #907373;">(</span>Xs<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>apply #'+ Xs<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>shen.mod . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/shen.mod</span> <span style="color: #907373;">(</span>N Div<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>mod N Div<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>integer? . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/integer?</span> <span style="color: #907373;">(</span>N<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>shen/internal/predicate-&gt;shen <span style="color: #6276BA;">(</span>integerp N<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>abs . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/shen.abs</span> <span style="color: #907373;">(</span>N<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>abs N<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span>nth . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/nth</span> <span style="color: #907373;">(</span>I Xs<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>nth I Xs<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3da0e33" class="outline-3">
<h3 id="org3da0e33"><span class="section-number-3">6.2</span> Hash Table</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/internal/*hash-table-overrides*
      '<span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">(</span>set *property-vector* <span style="color: #907373;">(</span>vector <span style="color: #D0372D;">20000</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span> . <span style="color: #709870;">(</span>shen/set '*property-vector*
                                                            <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>HashTable <span style="color: #80A880;">(</span>make-hash-table
                                                                              <span style="color: #006FE0;">:size</span> <span style="color: #D0372D;">1000</span>
                                                                              <span style="color: #006FE0;">:test</span> 'shen/internal/hash-table-test<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                                                              <span style="color: #6276BA;">(</span>puthash <span style="color: #D0372D;">0</span> <span style="color: #D0372D;">20000</span> HashTable<span style="color: #6276BA;">)</span>
                                                              HashTable<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>get . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/get</span>
                   <span style="color: #907373;">(</span>Pointer Key Table<span style="color: #907373;">)</span>
                 <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>Subtable <span style="color: #80A880;">(</span>gethash Pointer Table<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                   <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>not Subtable<span style="color: #858580;">)</span>
                       <span style="color: #858580;">(</span>shen/simple-error
                        <span style="color: #80A880;">(</span>format <span style="color: #008000;">"pointer not found: %s\n"</span> Pointer<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                     <span style="color: #858580;">(</span><span style="color: #0000FF;">let</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>Value <span style="color: #707183;">(</span>gethash Key Subtable<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                       <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> <span style="color: #887070;">(</span>not Value<span style="color: #887070;">)</span>
                           <span style="color: #887070;">(</span>shen/simple-error
                            <span style="color: #707183;">(</span>format <span style="color: #008000;">"value not found: %s\n"</span> <span style="color: #7388D6;">(</span>list Pointer Key<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                       Value<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>put . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/put</span>
                   <span style="color: #907373;">(</span>Pointer Key Value Table<span style="color: #907373;">)</span>
                 <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>Subtable <span style="color: #80A880;">(</span>gethash Pointer Table<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                   <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>not Subtable<span style="color: #858580;">)</span>
                       <span style="color: #858580;">(</span><span style="color: #0000FF;">let</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>Subtable <span style="color: #707183;">(</span>make-hash-table <span style="color: #006FE0;">:test</span> 'shen/internal/hash-table-test<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                         <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
                           <span style="color: #887070;">(</span>puthash Pointer Subtable Table<span style="color: #887070;">)</span>
                           <span style="color: #887070;">(</span>puthash Key Value Subtable<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                     <span style="color: #858580;">(</span>puthash Key Value Subtable<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>unput . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/unput</span>
                     <span style="color: #907373;">(</span>Pointer Key Table<span style="color: #907373;">)</span>
                   <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>Subtable <span style="color: #80A880;">(</span>gethash Pointer Table<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                     <span style="color: #6276BA;">(</span><span style="color: #0000FF;">and</span> Subtable
                          <span style="color: #858580;">(</span>remhash Key Subtable<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                     Pointer<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org5400114" class="outline-3">
<h3 id="org5400114"><span class="section-number-3">6.3</span> Namespacing</h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/internal/*namespacing-overrides*
      '<span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #0000FF;">function</span> . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/function</span> <span style="color: #907373;">(</span>S<span style="color: #907373;">)</span>
                      <span style="color: #907373;">(</span>shen/shen\.lookup-func
                       <span style="color: #6276BA;">(</span>shen/internal/unprefix-symbol S<span style="color: #6276BA;">)</span>
                       <span style="color: #6276BA;">(</span>shen/value 'shen\.*symbol-table*<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org84f1566" class="outline-3">
<h3 id="org84f1566"><span class="section-number-3">6.4</span> Bug Fixes</h3>
<div class="outline-text-3" id="text-6-4">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/internal/*bugfix-overrides*
      '<span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>untrack . <span style="color: #709870;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/untrack</span> <span style="color: #907373;">(</span>F<span style="color: #907373;">)</span>
                     <span style="color: #907373;">(</span><span style="color: #0000FF;">progn</span>
                       <span style="color: #6276BA;">(</span>shen/set shen.*tracking*
                                 <span style="color: #858580;">(</span>shen/internal/delete-first-eq
                                  F
                                  <span style="color: #80A880;">(</span>shen/value shen.*tracking*<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                       <span style="color: #6276BA;">(</span>shen/eval <span style="color: #858580;">(</span>shen/ps F<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6d93d5a" class="outline-2">
<h2 id="org6d93d5a"><span class="section-number-2">7</span> Evaluate KLambda</h2>
<div class="outline-text-2" id="text-7">
<p>
Now that the mechanisms for <a href="#org52f0e1d">applying functions</a>, and <a href="#org521dfcf">quoting/namespacing</a> are in place
converting KLambda to Elisp is just a couple of function calls.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/kl-to-elisp</span> <span style="color: #7388D6;">(</span>Kl<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>shen/internal/nil-to-null
   <span style="color: #909183;">(</span>shen/internal/add-1+
    <span style="color: #709870;">(</span>shen/internal/consolidate-tl
     <span style="color: #907373;">(</span>shen/internal/consolidate-@s
      <span style="color: #6276BA;">(</span>shen/internal/consolidate-cons <span style="color: #858580;">(</span>shen/internal/parse-ast Kl<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Evaluating KLambda to Elisp is straight forward except that a copy of the AST is
made when evaluating a <code>defun</code>. This is important because the AST is
destructively modified when compiled to Elisp and Shen requires the original
source for introspecting, profiling and tracking.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/eval-kl</span> <span style="color: #7388D6;">(</span>X<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #0000FF;">and</span> <span style="color: #709870;">(</span>consp X<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>eq <span style="color: #907373;">(</span>car X<span style="color: #907373;">)</span> 'defun<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #0000FF;">progn</span>
        <span style="color: #709870;">(</span>byte-compile <span style="color: #907373;">(</span>eval <span style="color: #6276BA;">(</span>shen/internal/kl-to-elisp <span style="color: #858580;">(</span>copy-tree X<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> 't<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>nth <span style="color: #D0372D;">1</span> X<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>eval <span style="color: #709870;">(</span>shen/internal/kl-to-elisp X<span style="color: #709870;">)</span> 't<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
<div id="outline-container-orgc281f1f" class="outline-3">
<h3 id="orgc281f1f"><span class="section-number-3">7.1</span> Generate From Seed KLambda Files</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Generating <code>shen-elisp.el</code>, the file that contains the Elisp compiled from the
bootstrap KLambda files, requires a slightly different approach because we
<a href="#orgeed8f15">override</a> the default generated Elisp with custom implementations. The <a href="#orgeed8f15">overrides</a>
from above are read into a hash table and will be spliced in <a href="#org34c67da">below</a>.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/internal/add-overrides</span> <span style="color: #7388D6;">(</span>overrides table<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>mapc
   <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>override<span style="color: #709870;">)</span>
     <span style="color: #709870;">(</span>puthash <span style="color: #907373;">(</span>car override<span style="color: #907373;">)</span>
              <span style="color: #907373;">(</span>cdr override<span style="color: #907373;">)</span>
              table<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   overrides<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/*overrides*
      <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>table <span style="color: #907373;">(</span>make-hash-table <span style="color: #006FE0;">:test</span> 'equal<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>shen/internal/add-overrides
         <span style="color: #709870;">(</span>append
          shen/internal/*performance-overrides*
          shen/internal/*hash-table-overrides*
          shen/internal/*namespacing-overrides*
          shen/internal/*bugfix-overrides*<span style="color: #709870;">)</span>
         table<span style="color: #909183;">)</span>
        table<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
<div id="outline-container-org34c67da" class="outline-4">
<h4 id="org34c67da"><span class="section-number-4">7.1.1</span> Evaluating Bootstrapped KLambda</h4>
<div class="outline-text-4" id="text-7-1-1">
<p>
When bootstrapping from the seed KLambda files we first need to <a href="#orgc281f1f">patch</a> the
incoming code with overrides before parsing the AST:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/patch-klambda</span> <span style="color: #7388D6;">(</span>ast<span style="color: #7388D6;">)</span>
 <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>eq <span style="color: #709870;">(</span>car ast<span style="color: #709870;">)</span> 'defun<span style="color: #909183;">)</span>
       <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>override <span style="color: #6276BA;">(</span>gethash <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">1</span> ast<span style="color: #858580;">)</span> shen/*overrides*<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span><span style="color: #0000FF;">or</span> override
             <span style="color: #907373;">(</span>shen/internal/parse-ast ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
     <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>patched <span style="color: #6276BA;">(</span>gethash ast shen/*overrides* <span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
       <span style="color: #709870;">(</span><span style="color: #0000FF;">or</span> patched
           <span style="color: #907373;">(</span>shen/internal/parse-ast ast<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
When saving the seed KLambda code to a file, first patch, then optimize and then append
to the end of the buffer.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/kl-to-buffer</span> <span style="color: #7388D6;">(</span>X B<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">with-current-buffer</span> B
    <span style="color: #909183;">(</span><span style="color: #0000FF;">save-excursion</span>
      <span style="color: #709870;">(</span>goto-char <span style="color: #907373;">(</span>point-max<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>insert <span style="color: #907373;">(</span>pp-to-string
               <span style="color: #6276BA;">(</span>shen/internal/nil-to-null
                <span style="color: #858580;">(</span>shen/internal/add-1+
                 <span style="color: #80A880;">(</span>shen/internal/consolidate-tl
                  <span style="color: #887070;">(</span>shen/internal/consolidate-@s
                   <span style="color: #707183;">(</span>shen/internal/consolidate-cons
                    <span style="color: #7388D6;">(</span>shen/patch-klambda X<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org5b7fbf5" class="outline-2">
<h2 id="org5b7fbf5"><span class="section-number-2">8</span> Providing The Primitives</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">provide</span> '<span style="color: #D0372D;">shen-primitives</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc420a27" class="outline-2">
<h2 id="orgc420a27"><span class="section-number-2">9</span> Overlays</h2>
<div class="outline-text-2" id="text-9">
<p>
Override of some of Shen's default implementations.
</p>
</div>
<div id="outline-container-orga4f7f1a" class="outline-3">
<h3 id="orga4f7f1a"><span class="section-number-3">9.1</span> License</h3>
<div class="outline-text-3" id="text-9-1">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Copyright (c) 2015-2016 Aditya Siram. All Rights Reserved.</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">BSD 3-Clause License: http://opensource.org/licenses/BSD-3-Clause</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org2ffa05c" class="outline-3">
<h3 id="org2ffa05c"><span class="section-number-3">9.2</span> Symbol Table</h3>
<div class="outline-text-3" id="text-9-2">
<p>
The Shen runtime maintains a ~*symbol-table* which is a mapping of all generated and
native functions to their partially applied lambda form.
</p>

<p>
The bootstrapped KLambda code uses simple alists which are inefficient and since
this structure has to be consulted thousands of times (especially while
typechecking), the KLambda provided implemenatation really slows everything
down so we need to migrate to a hash-table.
</p>

<p>
Additionally the bootstrap KLambda files actually fills up this structure with
some initial content for core functions and datatypes so they need to be migrated:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/migrate-symbol-table</span> <span style="color: #7388D6;">()</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>SymbolTable <span style="color: #907373;">(</span>shen/value 'shen.*symbol-table*<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>not <span style="color: #907373;">(</span>hash-table-p SymbolTable<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>NewTable <span style="color: #858580;">(</span>make-hash-table<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #6276BA;">(</span>Entry SymbolTable NewTable<span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>puthash <span style="color: #858580;">(</span>car Entry<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>cdr Entry<span style="color: #858580;">)</span> NewTable<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>shen/set 'shen.*symbol-table* NewTable<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      SymbolTable<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
And then the routines that find and add entries to the symbol table need to be
re-implemented:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/shen.lookup-func</span>
    <span style="color: #7388D6;">(</span>Name Table<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>Form <span style="color: #907373;">(</span>gethash Name Table<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>not Form<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>shen/simple-error
         <span style="color: #907373;">(</span>shen/shen.app Name <span style="color: #008000;">" has no lambda expansion\n"</span> 'shen.a<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      Form<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/shen.update-symbol-table</span>
    <span style="color: #7388D6;">(</span>Name Arity<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>lambda-function
         <span style="color: #907373;">(</span>shen/eval-kl
          <span style="color: #6276BA;">(</span>shen/shen.lambda-form Name Arity<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>puthash Name lambda-function <span style="color: #709870;">(</span>shen/value 'shen.*symbol-table*<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/value 'shen.*symbol-table*<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc0d74ec" class="outline-3">
<h3 id="orgc0d74ec"><span class="section-number-3">9.3</span> Repl</h3>
<div class="outline-text-3" id="text-9-3">
</div><div id="outline-container-orgf35e81e" class="outline-4">
<h4 id="orgf35e81e"><span class="section-number-4">9.3.1</span> Questions</h4>
<div class="outline-text-4" id="text-9-3-1">
<p>
Overlay the routines that take input from the user in the REPL session to use the mini-buffer
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/y-or-n?</span> <span style="color: #7388D6;">(</span>S<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span>
    <span style="color: #909183;">(</span>shen/shen.prhush <span style="color: #709870;">(</span>shen/shen.proc-nl S<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>shen/stoutput<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>Input <span style="color: #6276BA;">(</span>format <span style="color: #008000;">"%s"</span> <span style="color: #858580;">(</span>read-from-minibuffer <span style="color: #008000;">" (y/n) "</span> <span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>string-equal Input <span style="color: #008000;">"y"</span><span style="color: #6276BA;">)</span> 'true<span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>string-equal Input <span style="color: #008000;">"n"</span><span style="color: #6276BA;">)</span> 'false<span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span>t <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
            <span style="color: #858580;">(</span>shen/shen.prhush  <span style="color: #008000;">"please answer y or n~%"</span> <span style="color: #80A880;">(</span>shen/stoutput<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span>shen/y-or-n? S<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/shen.pause-for-user</span> nil
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>Byte <span style="color: #907373;">(</span>read-from-minibuffer <span style="color: #008000;">""</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span><span style="color: #0000FF;">and</span> <span style="color: #907373;">(</span>= <span style="color: #D0372D;">1</span> <span style="color: #6276BA;">(</span>length Byte<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> <span style="color: #907373;">(</span>= <span style="color: #6276BA;">(</span>string-to-char Byte<span style="color: #6276BA;">)</span> ?^<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>shen/simple-error <span style="color: #008000;">"input aborted\n"</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>shen/nl <span style="color: #D0372D;">1</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org79ef188" class="outline-4">
<h4 id="org79ef188"><span class="section-number-4">9.3.2</span> Changing Directories</h4>
<div class="outline-text-4" id="text-9-3-2">
<p>
When changing directories in the REPL, for convenience, also change Emacs' working directory.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/cd</span> <span style="color: #7388D6;">(</span>Path<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>shen/internal/shen-&gt;predicate <span style="color: #709870;">(</span>shen/= Path <span style="color: #008000;">""</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span>shen/set '*home-directory* <span style="color: #008000;">""</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">let</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>PathString <span style="color: #6276BA;">(</span>concat Path <span style="color: #008000;">"/"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> default-directory PathString<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>shen/set '*home-directory* PathString<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      PathString<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7605357" class="outline-3">
<h3 id="org7605357"><span class="section-number-3">9.4</span> Provide it</h3>
<div class="outline-text-3" id="text-9-4">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">provide</span> '<span style="color: #D0372D;">shen-repl</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7cf0e03" class="outline-2">
<h2 id="org7cf0e03"><span class="section-number-2">10</span> Shen REPL</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">-*- lexical-binding: t -*-</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Copyright (c) 2015-2016 Aditya Siram. All Rights Reserved.</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">BSD 3-Clause License: http://opensource.org/licenses/BSD-3-Clause</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">comint</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">shen-primitives</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">shen-elisp</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">shen-overlays</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
<div id="outline-container-org2401594" class="outline-3">
<h3 id="org2401594"><span class="section-number-3">10.1</span> Credits</h3>
<div class="outline-text-3" id="text-10-1">
<p>
The credits that appear at the top of each REPL session.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defconst</span> <span style="color: #BA36A5;">shen/shen.credits</span>
  <span style="color: #7388D6;">(</span>format <span style="color: #008000;">"%s\n%s\n%s\n%s\n\n"</span>
          <span style="color: #008000;">"Shen, copyright (C) 2010-2015 Mark Tarver"</span>
          <span style="color: #909183;">(</span>format <span style="color: #008000;">"www.shenlanguage.org, %s"</span> <span style="color: #709870;">(</span>shen/value '*version*<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">(</span>format <span style="color: #008000;">"running under %s, implementation: %s"</span> <span style="color: #709870;">(</span>shen/value '*language*<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>shen/value '*implementation*<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">(</span>format <span style="color: #008000;">"port %s ported by %s"</span> <span style="color: #709870;">(</span>shen/value '*port*<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>shen/value '*porters*<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc914fd4" class="outline-3">
<h3 id="orgc914fd4"><span class="section-number-3">10.2</span> Prompt</h3>
<div class="outline-text-3" id="text-10-2">
<p>
The Shen REPL prompt looks like <code>(0-)</code> and <code>(100+)</code> where the number is a
counter of the number of REPL interactions so far and the <code>-</code> and <code>+</code> indicate
whether typechecking is currently enabled.
</p>

<p>
First we tell the REPL how to recognize prompts:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defconst</span> <span style="color: #BA36A5;">shen/repl-prompt-regex</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">rx</span> line-start
      <span style="color: #909183;">(</span>char ?<span style="color: #709870;">(</span> <span style="color: #709870;">)</span>
            <span style="color: #709870;">(</span>1+ digit<span style="color: #709870;">)</span>
            <span style="color: #709870;">(</span><span style="color: #0000FF;">or</span> <span style="color: #907373;">(</span>char ?-<span style="color: #907373;">)</span> <span style="color: #907373;">(</span>char ?+<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
            <span style="color: #709870;">(</span>char ?<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span>char ? <span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
and make them:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/make-prompt</span> nil
  <span style="color: #7388D6;">(</span>format <span style="color: #008000;">"(%d%s) "</span>
          <span style="color: #909183;">(</span>shen/length <span style="color: #709870;">(</span>shen/value 'shen.*history*<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">(</span><span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>shen/internal/shen-&gt;predicate <span style="color: #907373;">(</span>shen/value 'shen.*tc*<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
              <span style="color: #008000;">"+"</span>
            <span style="color: #008000;">"-"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaacaf97" class="outline-3">
<h3 id="orgaacaf97"><span class="section-number-3">10.3</span> Input Events</h3>
<div class="outline-text-3" id="text-10-3">
<p>
In addition to evaluating input, the REPL also provides some rudimentary
completion support. Hitting <code>TAB</code> when inside a string tries to complete a
filename using <code>comint-filename-completion</code>. <code>shen/repl-complete-filename</code> is a
copy of <code>ielm-complete-filename</code>.
</p>

<p>
'TAB' after an open paren presents a list of Shen functions in scope. Since Shen
functions are just Elisp functions prefixed with "shen/" we use <code>mapatoms</code> to
iterate over all the symbols and functions and keep only the prefixed functions
as completion candidates. Other that <code>shen/repl-completion-at-point</code> pretty much
copies <code>elisp-completion-at-point</code>.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">shen/repl-map</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>map <span style="color: #907373;">(</span>make-sparse-keymap<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>define-key map <span style="color: #008000;">"\C-j"</span> 'shen/repl-send-input<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>define-key map <span style="color: #008000;">"\C-m"</span> 'shen/repl-return<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>define-key map <span style="color: #008000;">"\t"</span> 'shen/repl-tab<span style="color: #909183;">)</span>
    map<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defvaralias</span> '<span style="color: #BA36A5;">shen/repl-mode-map</span> 'shen/repl-map<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-return</span> nil
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">interactive</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>shen/repl-send-input<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-tab</span> nil
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">interactive</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>completion-at-point<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-complete-filename</span> nil
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">when</span> <span style="color: #909183;">(</span>nth <span style="color: #D0372D;">3</span> <span style="color: #709870;">(</span>parse-partial-sexp comint-last-input-start <span style="color: #907373;">(</span>point<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>comint-filename-completion<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-completion-at-point</span> nil
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>pos <span style="color: #907373;">(</span>point<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>beg <span style="color: #907373;">(</span><span style="color: #0000FF;">condition-case</span> nil
                  <span style="color: #6276BA;">(</span><span style="color: #0000FF;">save-excursion</span>
                    <span style="color: #858580;">(</span>backward-sexp <span style="color: #D0372D;">1</span><span style="color: #858580;">)</span>
                    <span style="color: #858580;">(</span>point<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
                <span style="color: #6276BA;">(</span>scan-error pos<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>end
          <span style="color: #907373;">(</span><span style="color: #0000FF;">unless</span> <span style="color: #6276BA;">(</span><span style="color: #0000FF;">or</span> <span style="color: #858580;">(</span>eq beg <span style="color: #80A880;">(</span>point-max<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                      <span style="color: #858580;">(</span>member <span style="color: #80A880;">(</span>char-syntax <span style="color: #887070;">(</span>char-after beg<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                              '<span style="color: #80A880;">(</span>?\s ?\" ?\( ?\)<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">condition-case</span> nil
                <span style="color: #858580;">(</span><span style="color: #0000FF;">save-excursion</span>
                  <span style="color: #80A880;">(</span>goto-char beg<span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span>forward-sexp <span style="color: #D0372D;">1</span><span style="color: #80A880;">)</span>
                  <span style="color: #80A880;">(</span><span style="color: #0000FF;">when</span> <span style="color: #887070;">(</span>&gt;= <span style="color: #707183;">(</span>point<span style="color: #707183;">)</span> pos<span style="color: #887070;">)</span>
                    <span style="color: #887070;">(</span>point<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span>scan-error pos<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>shen-functions
          <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>res <span style="color: #80A880;">(</span>make-vector <span style="color: #D0372D;">100</span> <span style="color: #D0372D;">0</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>mapatoms
             <span style="color: #858580;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #80A880;">(</span>S<span style="color: #80A880;">)</span>
               <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> <span style="color: #887070;">(</span><span style="color: #0000FF;">and</span> <span style="color: #707183;">(</span>fboundp S<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>string-prefix-p shen/prefix <span style="color: #7388D6;">(</span>symbol-name S<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                   <span style="color: #887070;">(</span>intern <span style="color: #707183;">(</span>substring <span style="color: #7388D6;">(</span>symbol-name S<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>length shen/prefix<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                           res<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            res<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>list beg end shen-functions<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org37268e6" class="outline-3">
<h3 id="org37268e6"><span class="section-number-3">10.4</span> Sending Input</h3>
<div class="outline-text-3" id="text-10-4">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defvar</span> <span style="color: #BA36A5;">shen/repl-input</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-send-input</span> nil
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">interactive</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span>
    <span style="color: #909183;">(</span>comint-send-input<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">condition-case</span> ex
        <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
          <span style="color: #907373;">(</span>shen/shen.initialise_environment<span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>shen/repl-eval <span style="color: #6276BA;">(</span>string-to-list shen/repl-input<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>'error
       <span style="color: #907373;">(</span>comint-output-filter <span style="color: #6276BA;">(</span>shen/repl-process<span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span>format <span style="color: #008000;">"%s\n%s"</span> ex  <span style="color: #858580;">(</span>shen/make-prompt<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span><span style="color: #ff0000; font-weight: bold;">signal</span> <span style="color: #6276BA;">(</span>car ex<span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span>cdr ex<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">with-current-buffer</span> *shen-repl*
      <span style="color: #709870;">(</span>goto-char <span style="color: #907373;">(</span>point-max<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9e4d6b2" class="outline-3">
<h3 id="org9e4d6b2"><span class="section-number-3">10.5</span> Evaluating User Input</h3>
<div class="outline-text-3" id="text-10-5">
<p>
The following is a cut-and-paste of <code>ielm-standard-output-impl</code> which apparently
does not exist in older versions of Emacs (a user reported a bug on 24.4.1).
</p>

<p>
It periodically writes to the REPL.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-standard-output-impl</span> <span style="color: #7388D6;">(</span>process<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>output-buffer nil<span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>flush-timer nil<span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>flush-buffer
          <span style="color: #907373;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #6276BA;">()</span>
            <span style="color: #6276BA;">(</span>comint-output-filter
             process
             <span style="color: #858580;">(</span>apply #'string <span style="color: #80A880;">(</span>nreverse output-buffer<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>redisplay<span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setf</span> output-buffer nil<span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">when</span> flush-timer
              <span style="color: #858580;">(</span>cancel-timer flush-timer<span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">setf</span> flush-timer nil<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>char<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span>flush-now<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">cond</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span><span style="color: #0000FF;">and</span> <span style="color: #80A880;">(</span>eq char t<span style="color: #80A880;">)</span> output-buffer<span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span><span style="color: #0000FF;">setf</span> flush-now t<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
              <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>characterp char<span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span><span style="color: #0000FF;">push</span> char output-buffer<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">if</span> flush-now
            <span style="color: #6276BA;">(</span>funcall flush-buffer<span style="color: #6276BA;">)</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">unless</span> flush-timer
            <span style="color: #858580;">(</span><span style="color: #0000FF;">setf</span> flush-timer <span style="color: #80A880;">(</span>run-with-timer <span style="color: #D0372D;">0.1</span> nil flush-buffer<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-process</span> nil
  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Return the current buffer's process.</span>
  <span style="color: #7388D6;">(</span>get-buffer-process <span style="color: #909183;">(</span>current-buffer<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-eval</span> <span style="color: #7388D6;">(</span>input-string<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>active-process <span style="color: #907373;">(</span>shen/repl-process<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>shen/repl-temp-buffer<span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>clean-up <span style="color: #907373;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #6276BA;">(</span>active-process <span style="color: #6434A3;">&amp;optional</span> ex<span style="color: #6276BA;">)</span>
                     <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
                       <span style="color: #858580;">(</span>funcall <span style="color: #80A880;">(</span>shen/value '*stoutput*<span style="color: #80A880;">)</span> t<span style="color: #858580;">)</span>
                       <span style="color: #858580;">(</span>comint-output-filter active-process
                                             <span style="color: #80A880;">(</span><span style="color: #0000FF;">if</span> ex
                                                 <span style="color: #887070;">(</span>format <span style="color: #008000;">"\n%s\n\n%s"</span> <span style="color: #707183;">(</span>nth <span style="color: #D0372D;">1</span> ex<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>shen/make-prompt<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                                               <span style="color: #887070;">(</span>format <span style="color: #008000;">"\n%s"</span> <span style="color: #707183;">(</span>shen/make-prompt<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                       <span style="color: #858580;">(</span>shen/set '*stoutput* standard-output<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">condition-case</span> ex
        <span style="color: #709870;">(</span><span style="color: #0000FF;">progn</span>
          <span style="color: #907373;">(</span>shen/set '*stoutput* <span style="color: #6276BA;">(</span>shen/repl-standard-output-impl active-process<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span>set-buffer <span style="color: #6276BA;">(</span>get-buffer *shen-repl*<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #907373;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>Lineread
                  <span style="color: #80A880;">(</span>shen/compile #'shen/shen.&lt;st_input&gt; input-string
                                <span style="color: #887070;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #707183;">(</span>Err<span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #ff0000; font-weight: bold;">signal</span> <span style="color: #7388D6;">(</span>car Err<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>cdr Err<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span>It <span style="color: #80A880;">(</span>shen/shen.record-it input-string<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span>History <span style="color: #80A880;">(</span>shen/value 'shen.*history*<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span>NewLineread <span style="color: #80A880;">(</span>shen/shen.retrieve-from-history-if-needed
                               <span style="color: #887070;">(</span>shen/@p Lineread input-string<span style="color: #887070;">)</span>
                               History<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span>NewHistory <span style="color: #80A880;">(</span>shen/shen.update_history NewLineread History<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span>Parsed <span style="color: #80A880;">(</span>shen/fst NewLineread<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">if</span> <span style="color: #858580;">(</span>not Parsed<span style="color: #858580;">)</span>
                <span style="color: #858580;">(</span>funcall clean-up active-process<span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">progn</span>
                <span style="color: #80A880;">(</span>shen/shen.toplevel Parsed<span style="color: #80A880;">)</span>
                <span style="color: #80A880;">(</span>funcall <span style="color: #887070;">(</span>shen/value '*stoutput*<span style="color: #887070;">)</span> t<span style="color: #80A880;">)</span>
                <span style="color: #80A880;">(</span>comint-output-filter active-process <span style="color: #887070;">(</span>format <span style="color: #008000;">"\n%s"</span> <span style="color: #707183;">(</span>shen/make-prompt<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>'shen/error <span style="color: #907373;">(</span>funcall clean-up active-process ex<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge6d04f7" class="outline-3">
<h3 id="orge6d04f7"><span class="section-number-3">10.6</span> The REPL Mode</h3>
<div class="outline-text-3" id="text-10-6">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defconst</span> <span style="color: #BA36A5;">shen/syntax-table</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>table <span style="color: #907373;">(</span>make-syntax-table lisp-mode-syntax-table<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>modify-syntax-entry <span style="color: #D0372D;">59</span> <span style="color: #008000;">"_"</span><span style="color: #909183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">semi-colon</span>
    <span style="color: #909183;">(</span>modify-syntax-entry ?, <span style="color: #008000;">"_"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>modify-syntax-entry ?# <span style="color: #008000;">"_"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>modify-syntax-entry ?' <span style="color: #008000;">"_"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>modify-syntax-entry ?` <span style="color: #008000;">"_"</span><span style="color: #909183;">)</span>
    table<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-input-sender</span> <span style="color: #7388D6;">(</span>_proc input<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> shen/repl-input input<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-pm</span> nil
  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Return the process mark of the current buffer.</span>
  <span style="color: #7388D6;">(</span>process-mark <span style="color: #909183;">(</span>get-buffer-process <span style="color: #709870;">(</span>current-buffer<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl-set-pm</span> <span style="color: #7388D6;">(</span>pos<span style="color: #7388D6;">)</span>
  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Set the process mark in the current buffer to POS.</span>
  <span style="color: #7388D6;">(</span>set-marker <span style="color: #909183;">(</span>process-mark <span style="color: #709870;">(</span>get-buffer-process <span style="color: #907373;">(</span>current-buffer<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span> pos<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">define-derived-mode</span> <span style="color: #006699;">shen/repl-mode</span> comint-mode <span style="color: #008000;">"shen-repl-mode"</span>
  <span style="color: #006FE0;">:syntax-table</span> shen/syntax-table
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> comint-prompt-regexp shen/repl-prompt-regex<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> comint-use-prompt-regexp t<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> comint-prompt-read-only t<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq</span> comint-input-sender 'shen/repl-input-sender<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">setq-local</span> comment-use-syntax 'undecided<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>set <span style="color: #909183;">(</span>make-local-variable 'completion-at-point-functions<span style="color: #909183;">)</span>
       '<span style="color: #909183;">(</span>comint-replace-by-expanded-history
         shen/repl-complete-filename
         shen/repl-completion-at-point<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">unless</span> <span style="color: #909183;">(</span>comint-check-proc <span style="color: #709870;">(</span>current-buffer<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">condition-case</span> nil
        <span style="color: #709870;">(</span>start-process <span style="color: #008000;">"shen/repl"</span> <span style="color: #907373;">(</span>current-buffer<span style="color: #907373;">)</span> <span style="color: #008000;">"cat"</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>file-error <span style="color: #907373;">(</span>start-process <span style="color: #008000;">"shen/repl"</span> <span style="color: #6276BA;">(</span>current-buffer<span style="color: #6276BA;">)</span> <span style="color: #008000;">"hexl"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>set-process-query-on-exit-flag <span style="color: #709870;">(</span>shen/repl-process<span style="color: #709870;">)</span> nil<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>goto-char <span style="color: #709870;">(</span>point-max<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>set <span style="color: #709870;">(</span>make-local-variable 'comint-inhibit-carriage-motion<span style="color: #709870;">)</span> t<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>insert shen/shen.credits<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/repl-set-pm <span style="color: #709870;">(</span>point-max<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>comint-output-filter <span style="color: #709870;">(</span>shen/repl-process<span style="color: #709870;">)</span> <span style="color: #008000;">"(0-) "</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>set-marker comint-last-input-start <span style="color: #709870;">(</span>shen/repl-pm<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>set-process-filter <span style="color: #709870;">(</span>get-buffer-process <span style="color: #907373;">(</span>current-buffer<span style="color: #907373;">)</span><span style="color: #709870;">)</span> 'comint-output-filter<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defconst</span> <span style="color: #BA36A5;">*shen-repl*</span> <span style="color: #008000;">"*shen-repl*"</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org06658cf" class="outline-3">
<h3 id="org06658cf"><span class="section-number-3">10.7</span> Starting the REPL</h3>
<div class="outline-text-3" id="text-10-7">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #8D8D84;">;;;</span><span style="color: #8D8D84; font-style: italic;">###</span><span style="color: #ff0000; font-weight: bold; font-style: italic;">autoload</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/repl</span> nil
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">interactive</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span>old-point<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">unless</span> <span style="color: #709870;">(</span>get-buffer *shen-repl*<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">with-current-buffer</span> <span style="color: #907373;">(</span>get-buffer-create *shen-repl*<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>make-local-variable 'lexical-binding<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>load <span style="color: #008000;">"shen-primitives.elc"</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>load <span style="color: #008000;">"shen-elisp.elc"</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>load <span style="color: #008000;">"shen-overlays.elc"</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>shen/migrate-symbol-table<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> lexical-binding 't<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>shen/set 'shen.*history* '<span style="color: #6276BA;">()</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>shen/set '*home-directory* <span style="color: #008000;">""</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>shen/set 'shen.*tc* 'false<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">unless</span> <span style="color: #6276BA;">(</span>zerop <span style="color: #858580;">(</span>buffer-size<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span><span style="color: #0000FF;">setq</span> old-point <span style="color: #858580;">(</span>point<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>shen/repl-mode<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>switch-to-buffer *shen-repl*<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">when</span> old-point <span style="color: #709870;">(</span>push-mark old-point<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org270053c" class="outline-3">
<h3 id="org270053c"><span class="section-number-3">10.8</span> Provide it</h3>
<div class="outline-text-3" id="text-10-8">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">provide</span> '<span style="color: #D0372D;">shen-repl</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb70a2fe" class="outline-2">
<h2 id="orgb70a2fe"><span class="section-number-2">11</span> Bootstrap</h2>
<div class="outline-text-2" id="text-11">
<p>
Bootstrapping a Shen environment involves
</p>
<ol class="org-ol">
<li>collecting all the KLambda files in the "KLambda" directory in this package into a variable</li>
<li>modifying the Elisp reader so it doesn't choke on what it would consider illegal symbols in KLambda</li>
<li>iterating over the KLambda files, parse out and evaluate KLambda s-expressions</li>
<li>providing a runner that kicks off the process</li>
</ol>
</div>
<div id="outline-container-org3d4557f" class="outline-3">
<h3 id="org3d4557f"><span class="section-number-3">11.1</span> Collecting KLambda files</h3>
<div class="outline-text-3" id="text-11-1">
<p>
In order to bootstrap the environment we specify the location of all the KLambda files
that need to be read in and compiled. They are located in the <code>KLambda</code> directory of this
package.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">require</span> '<span style="color: #D0372D;">shen-primitives</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> *klambda-directory-name* <span style="color: #008000;">"KLambda"</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> *klambda-directory* <span style="color: #7388D6;">(</span>file-name-as-directory <span style="color: #909183;">(</span>concat <span style="color: #709870;">(</span>file-name-directory load-file-name<span style="color: #709870;">)</span> *klambda-directory-name*<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> *klambda-files*
      <span style="color: #7388D6;">(</span>mapcar <span style="color: #909183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #709870;">(</span>klFile<span style="color: #709870;">)</span> <span style="color: #709870;">(</span>concat *klambda-directory* klFile<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
              '<span style="color: #909183;">(</span><span style="color: #008000;">"toplevel.kl"</span> <span style="color: #008000;">"core.kl"</span> <span style="color: #008000;">"sys.kl"</span> <span style="color: #008000;">"sequent.kl"</span> <span style="color: #008000;">"yacc.kl"</span>
                <span style="color: #008000;">"reader.kl"</span> <span style="color: #008000;">"prolog.kl"</span> <span style="color: #008000;">"track.kl"</span> <span style="color: #008000;">"load.kl"</span> <span style="color: #008000;">"writer.kl"</span>
                <span style="color: #008000;">"macros.kl"</span> <span style="color: #008000;">"declarations.kl"</span> <span style="color: #008000;">"types.kl"</span> <span style="color: #008000;">"t-star.kl"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
In order to read in the KLambda s-expressions using the Elisp reader we need to
make some adjustments due to the differences between KLambda and Elisp.
</p>
</div>
</div>
<div id="outline-container-org31e1acb" class="outline-3">
<h3 id="org31e1acb"><span class="section-number-3">11.2</span> Modifying The Elisp Reader For KLambda</h3>
<div class="outline-text-3" id="text-11-2">
<p>
In KLambda semicolons, colons, commas, ticks and backquotes are valid symbols. Since they have
different meanings in Elisp they will be rejected by the reader by default so we
need to insert them as regular symbols into a temporary <code>syntax-table</code> and then
parse out the s-expressions.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/*klambda-syntax-table*
      <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>table <span style="color: #907373;">(</span>make-syntax-table lisp-mode-syntax-table<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>modify-syntax-entry <span style="color: #D0372D;">59</span> <span style="color: #008000;">"_"</span> table<span style="color: #909183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">semi-colon</span>
        <span style="color: #909183;">(</span>modify-syntax-entry ?, <span style="color: #008000;">"_"</span> table<span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>modify-syntax-entry ?# <span style="color: #008000;">"_"</span> table<span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>modify-syntax-entry ?' <span style="color: #008000;">"_"</span> table<span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>modify-syntax-entry ?` <span style="color: #008000;">"_"</span> table<span style="color: #909183;">)</span>
        table<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/get-klambda-sexp-strings</span> <span style="color: #7388D6;">(</span>klambda-file<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">with-temp-buffer</span>
    <span style="color: #909183;">(</span>insert-file-contents klambda-file<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">with-syntax-table</span> shen/*klambda-syntax-table*
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>klambda-code <span style="color: #858580;">(</span>buffer-string<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>current-sexp-end <span style="color: #858580;">(</span>scan-lists <span style="color: #D0372D;">0</span> <span style="color: #D0372D;">1</span> <span style="color: #D0372D;">0</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
             <span style="color: #6276BA;">(</span>groups nil<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">progn</span>
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">while</span> current-sexp-end
            <span style="color: #858580;">(</span><span style="color: #0000FF;">let</span> <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>current-sexp-start <span style="color: #707183;">(</span>scan-lists current-sexp-end <span style="color: #D0372D;">-1</span> <span style="color: #D0372D;">0</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
              <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
                <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> groups <span style="color: #707183;">(</span>nconc groups <span style="color: #7388D6;">(</span>list <span style="color: #909183;">(</span>buffer-substring current-sexp-start current-sexp-end<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> current-sexp-end <span style="color: #707183;">(</span>scan-lists current-sexp-end <span style="color: #D0372D;">1</span> <span style="color: #D0372D;">0</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          groups<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Even though simply changing the syntax table works for parsing the s-expressions
as strings, the Elisp reader will still choke on illegal characters.
</p>

<p>
Each of those forbidden characters is encoded as a string that is unlikely to
occur in the normal course of events (hopefully). The name of the character is
interleaved with its reverse and prefixed an <code>_</code>. So, for example, <code>#</code> , spelled
"hash" becomes "_hhassahh" which is the interleaving of "hash" and "hsah" with a
leading underscore.
</p>

<p>
The mappings are stored in an alist and forward and reverse lookup functions are
provided
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/*illegal-character-&gt;spelling*
      '<span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #D0372D;">59</span> <span style="color: #008000;">"_sneomlioccoilmoens"</span><span style="color: #909183;">)</span>  <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">semicolon</span>
        <span style="color: #909183;">(</span>?, <span style="color: #008000;">"_caommmmoac"</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span><span style="color: #D0372D;">35</span> <span style="color: #008000;">"_hhassshh"</span><span style="color: #909183;">)</span>            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">hash</span>
        <span style="color: #909183;">(</span>?' <span style="color: #008000;">"_tkiccikt"</span><span style="color: #909183;">)</span>
        <span style="color: #909183;">(</span>?` <span style="color: #008000;">"_beatcokuqqukoctaeb"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> shen/*spelling-&gt;illegal-character*
      <span style="color: #7388D6;">(</span>mapcar #'reverse shen/*illegal-character-&gt;spelling*<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>


<p>
With the mapping in place the klambda s-expressions can be sanitized for the Elisp reader:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/remove-reserved-elisp-characters</span> <span style="color: #7388D6;">(</span>klambda-sexp-string<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>InString nil<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>illegal-characters
         <span style="color: #907373;">(</span>mapcar
          <span style="color: #6276BA;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #858580;">(</span>char-&gt;spelling<span style="color: #858580;">)</span> <span style="color: #858580;">(</span>nth <span style="color: #D0372D;">0</span> char-&gt;spelling<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
          shen/*illegal-character-&gt;spelling*<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>res<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>curr klambda-sexp-string<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">cl-flet</span> <span style="color: #709870;">(</span><span style="color: #907373;">(</span>append-and-advance
               <span style="color: #6276BA;">(</span><span style="color: #6434A3;">&amp;optional</span> X<span style="color: #6276BA;">)</span>
               <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
                 <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> X <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> res <span style="color: #887070;">(</span>concat res X<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                   <span style="color: #80A880;">(</span><span style="color: #0000FF;">setq</span> res <span style="color: #887070;">(</span>concat res <span style="color: #707183;">(</span>substring curr <span style="color: #D0372D;">0</span> <span style="color: #D0372D;">1</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                 <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> curr <span style="color: #80A880;">(</span>substring curr <span style="color: #D0372D;">1</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">while</span> <span style="color: #907373;">(</span>not <span style="color: #6276BA;">(</span>= <span style="color: #D0372D;">0</span> <span style="color: #858580;">(</span>length curr<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">cond</span>
         <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>char-equal <span style="color: #80A880;">(</span>string-to-char curr<span style="color: #80A880;">)</span> ?\"<span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> InString
              <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
                <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> InString nil<span style="color: #887070;">)</span>
                <span style="color: #887070;">(</span>append-and-advance<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
            <span style="color: #80A880;">(</span><span style="color: #0000FF;">progn</span>
              <span style="color: #887070;">(</span><span style="color: #0000FF;">setq</span> InString 't<span style="color: #887070;">)</span>
              <span style="color: #887070;">(</span>append-and-advance<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
         <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>memq <span style="color: #80A880;">(</span>string-to-char curr<span style="color: #80A880;">)</span> illegal-characters<span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> InString
              <span style="color: #80A880;">(</span>append-and-advance<span style="color: #80A880;">)</span>
            <span style="color: #80A880;">(</span>append-and-advance
             <span style="color: #887070;">(</span>car <span style="color: #707183;">(</span>assoc-default
                   <span style="color: #7388D6;">(</span>string-to-char curr<span style="color: #7388D6;">)</span>
                   shen/*illegal-character-&gt;spelling*<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
         <span style="color: #6276BA;">(</span>t <span style="color: #858580;">(</span>append-and-advance<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      res<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Once the reader has accepted the s-expression, the symbols need to be switched back to their
original spellings:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/put-reserved-elisp-chars-back</span> <span style="color: #7388D6;">(</span>sexp<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>symbols <span style="color: #907373;">(</span>shen/find-symbols sexp<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/internal/modify-ast sexp
                     symbols
                     <span style="color: #709870;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #907373;">(</span>path ast<span style="color: #907373;">)</span>
                       <span style="color: #907373;">(</span>shen/change-back <span style="color: #6276BA;">(</span>shen/internal/get-element-at path ast<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
To do so we need a function that iterates over a symbols and replaces the sanitized
spelling with the original character:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/change-back</span> <span style="color: #7388D6;">(</span>symbol<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let*</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>original-length <span style="color: #907373;">(</span>length <span style="color: #6276BA;">(</span>symbol-name symbol<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>string-left <span style="color: #907373;">(</span>symbol-name symbol<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>spelling-&gt;character
          <span style="color: #907373;">(</span><span style="color: #0000FF;">let</span> <span style="color: #6276BA;">(</span><span style="color: #858580;">(</span>hash <span style="color: #80A880;">(</span>make-hash-table<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span>mapcar <span style="color: #858580;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #80A880;">(</span>spelling-character<span style="color: #80A880;">)</span>
                      <span style="color: #80A880;">(</span>puthash <span style="color: #887070;">(</span>nth <span style="color: #D0372D;">0</span> spelling-character<span style="color: #887070;">)</span> <span style="color: #887070;">(</span>nth <span style="color: #D0372D;">1</span> spelling-character<span style="color: #887070;">)</span> hash<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
                    shen/*spelling-&gt;illegal-character*<span style="color: #6276BA;">)</span>
            hash<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>spellings <span style="color: #907373;">(</span>hash-table-keys spelling-&gt;character<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>get-character-and-remaining
          <span style="color: #907373;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #6276BA;">(</span>S<span style="color: #6276BA;">)</span>
            <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>found-at-index <span style="color: #887070;">(</span>shen/internal/index-of <span style="color: #707183;">(</span><span style="color: #0000FF;">lambda</span> <span style="color: #7388D6;">(</span>spelling<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>string-prefix-p spelling S<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> spellings<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
              <span style="color: #858580;">(</span><span style="color: #0000FF;">if</span> found-at-index
                  <span style="color: #80A880;">(</span><span style="color: #0000FF;">let</span> <span style="color: #887070;">(</span><span style="color: #707183;">(</span>spelling <span style="color: #7388D6;">(</span>nth found-at-index spellings<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                    <span style="color: #887070;">(</span>list <span style="color: #707183;">(</span>string <span style="color: #7388D6;">(</span>gethash spelling spelling-&gt;character<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                          <span style="color: #707183;">(</span>substring S <span style="color: #7388D6;">(</span>length spelling<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
                <span style="color: #80A880;">(</span>list <span style="color: #887070;">(</span>string <span style="color: #707183;">(</span>aref S <span style="color: #D0372D;">0</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                      <span style="color: #887070;">(</span>substring S <span style="color: #D0372D;">1</span><span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span>reversed-result<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">while</span> <span style="color: #709870;">(</span>&gt; <span style="color: #907373;">(</span>length string-left<span style="color: #907373;">)</span> <span style="color: #D0372D;">0</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">let</span> <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>character-and-remaining <span style="color: #858580;">(</span>funcall get-character-and-remaining string-left<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">push</span> <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">0</span> character-and-remaining<span style="color: #6276BA;">)</span> reversed-result<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #0000FF;">setq</span> string-left <span style="color: #6276BA;">(</span>nth <span style="color: #D0372D;">1</span> character-and-remaining<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>intern <span style="color: #709870;">(</span>apply #'concat <span style="color: #907373;">(</span>reverse reversed-result<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
And a function that collects paths to all symbols in an s-expression:
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">shen/find-symbols</span> <span style="color: #7388D6;">(</span>sexp<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>symbols<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>current-path<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>current-list sexp<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>current-list-length <span style="color: #907373;">(</span>length sexp<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>current-index <span style="color: #D0372D;">0</span><span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>locally-scoped-symbols<span style="color: #709870;">)</span>
        <span style="color: #709870;">(</span>inner-lists<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #0000FF;">while</span> <span style="color: #709870;">(</span><span style="color: #0000FF;">or</span> <span style="color: #907373;">(</span>&lt; current-index current-list-length<span style="color: #907373;">)</span>
               inner-lists<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">cond</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span><span style="color: #0000FF;">and</span> <span style="color: #858580;">(</span>= current-index current-list-length<span style="color: #858580;">)</span> inner-lists<span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span><span style="color: #0000FF;">progn</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> current-path <span style="color: #80A880;">(</span>car inner-lists<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> inner-lists <span style="color: #80A880;">(</span>cdr inner-lists<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> current-list <span style="color: #80A880;">(</span>shen/internal/get-element-at current-path sexp<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #D0372D;">0</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> current-list-length <span style="color: #80A880;">(</span>length current-list<span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span><span style="color: #6276BA;">(</span>&lt; current-index current-list-length<span style="color: #6276BA;">)</span>
        <span style="color: #6276BA;">(</span><span style="color: #0000FF;">let</span> <span style="color: #858580;">(</span><span style="color: #80A880;">(</span>current-token <span style="color: #887070;">(</span>nth current-index current-list<span style="color: #887070;">)</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">cond</span>
           <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>symbolp current-token<span style="color: #887070;">)</span>
            <span style="color: #887070;">(</span><span style="color: #0000FF;">push</span> <span style="color: #707183;">(</span>cons current-index current-path<span style="color: #707183;">)</span> symbols<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
           <span style="color: #80A880;">(</span><span style="color: #887070;">(</span>consp current-token<span style="color: #887070;">)</span>
            <span style="color: #887070;">(</span><span style="color: #0000FF;">push</span> <span style="color: #707183;">(</span>cons current-index current-path<span style="color: #707183;">)</span>
                  inner-lists<span style="color: #887070;">)</span><span style="color: #80A880;">)</span>
           <span style="color: #80A880;">(</span>t nil<span style="color: #80A880;">)</span><span style="color: #858580;">)</span>
          <span style="color: #858580;">(</span><span style="color: #0000FF;">setq</span> current-index <span style="color: #80A880;">(</span>+ current-index <span style="color: #D0372D;">1</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
       <span style="color: #907373;">(</span>t nil<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    symbols<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org88f1618" class="outline-3">
<h3 id="org88f1618"><span class="section-number-3">11.3</span> Iterating over KLambda Files</h3>
<div class="outline-text-3" id="text-11-3">
<p>
Now we can finally collect, and parse all the s-expressions in the
KLambda files and then pass the result to <code>shen/eval-kl</code> to transform
KLambda code into Elisp.
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> *temp-shen-buffer*
      <span style="color: #7388D6;">(</span>find-file-noselect
       <span style="color: #909183;">(</span>concat <span style="color: #709870;">(</span>file-name-as-directory default-directory<span style="color: #709870;">)</span>
               <span style="color: #709870;">(</span>file-relative-name <span style="color: #008000;">"shen-elisp.el"</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">eval-klambda-files</span> <span style="color: #7388D6;">(</span>klambda-files<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">with-current-buffer</span> *temp-shen-buffer*
    <span style="color: #909183;">(</span><span style="color: #0000FF;">progn</span>
      <span style="color: #709870;">(</span>erase-buffer<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>insert <span style="color: #008000;">"\</span>
<span style="color: #008000;">;;; shen-elisp.el --- An implementation of the Shen programming language  -*- lexical-binding: t -*-</span>

<span style="color: #008000;">;; Copyright (C) 2015-2016  Aditya Siram</span>

<span style="color: #008000;">;; Author: Aditya Siram <a href="mailto:aditya.siram%40gmail.com">&lt;aditya.siram@gmail.com&gt;</a></span>
<span style="color: #008000;">;; Homepage: https://github.com/deech/shen-elisp</span>
<span style="color: #008000;">;; License: BSD 3-Clause License</span>
<span style="color: #008000;">;;   http://opensource.org/licenses/BSD-3-Clause</span>

<span style="color: #008000;">;;; Commentary:</span>

<span style="color: #008000;">;; This is an implemenatation of the Shen programming language in</span>
<span style="color: #008000;">;; Elisp. The end goal is to provide:</span>
<span style="color: #008000;">;;</span>
<span style="color: #008000;">;; 1. An easy way to play with Shen with no other installation</span>
<span style="color: #008000;">;;    hassle (assuming you use Emacs).</span>
<span style="color: #008000;">;; 2. A first-class development experience when writing Shen.</span>
<span style="color: #008000;">;;    The idea is that an editor that understands the code can</span>
<span style="color: #008000;">;;    be much more helpful than one that does not. To this end</span>
<span style="color: #008000;">;;    the roadmap involves a full gamut of source code</span>
<span style="color: #008000;">;;    introspection and debugging tools.</span>

<span style="color: #008000;">;;; Code:</span>

<span style="color: #008000;">(require 'shen-primitives)</span>
<span style="color: #008000;">(setq max-lisp-eval-depth 60000)</span>
<span style="color: #008000;">(setq max-specpdl-size 13000)\n\n"</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>goto-char <span style="color: #907373;">(</span>point-max<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #907373;">(</span>klambda-file klambda-files nil<span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>eval-klambda-file klambda-file<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>goto-char <span style="color: #907373;">(</span>point-max<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>insert <span style="color: #907373;">(</span>format <span style="color: #008000;">"%s\n"</span> <span style="color: #008000;">"(provide 'shen-elisp)"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>save-buffer<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">eval-klambda-file</span> <span style="color: #7388D6;">(</span>klambda-file<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">dolist</span> <span style="color: #909183;">(</span>klambda-sexp-string <span style="color: #709870;">(</span>shen/get-klambda-sexp-strings klambda-file<span style="color: #709870;">)</span> nil<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>eval-klambda-sexp-string klambda-sexp-string<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">eval-klambda-sexp-string</span> <span style="color: #7388D6;">(</span>klambda-sexp-string<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>ast <span style="color: #907373;">(</span>shen/put-reserved-elisp-chars-back
              <span style="color: #6276BA;">(</span>read
               <span style="color: #858580;">(</span>shen/remove-reserved-elisp-characters
                klambda-sexp-string<span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/kl-to-buffer ast *temp-shen-buffer*<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org12cfa52" class="outline-2">
<h2 id="org12cfa52"><span class="section-number-2">12</span> The Runner</h2>
<div class="outline-text-2" id="text-12">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">compile-and-load</span> <span style="color: #7388D6;">(</span>F<span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>byte-compile-file
   <span style="color: #909183;">(</span>concat <span style="color: #709870;">(</span>file-name-as-directory default-directory<span style="color: #709870;">)</span>
           <span style="color: #709870;">(</span>file-relative-name F<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
   't<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">load-klambda</span> <span style="color: #7388D6;">()</span> <span style="color: #7388D6;">(</span>eval-klambda-files *klambda-files*<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">load-only</span> <span style="color: #7388D6;">()</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span>
    <span style="color: #909183;">(</span>compile-and-load <span style="color: #008000;">"shen-primitives.el"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>compile-and-load <span style="color: #008000;">"install.el"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defun</span> <span style="color: #006699;">runner</span> <span style="color: #7388D6;">()</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">progn</span>
    <span style="color: #909183;">(</span>compile-and-load <span style="color: #008000;">"shen-primitives.el"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>compile-and-load <span style="color: #008000;">"install.el"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>eval-klambda-files *klambda-files*<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>compile-and-load <span style="color: #008000;">"shen-elisp.el"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>compile-and-load <span style="color: #008000;">"shen-overlays.el"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>compile-and-load <span style="color: #008000;">"shen-repl.el"</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>add-to-load-path default-directory<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>shen/repl<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Aditya Siram</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>